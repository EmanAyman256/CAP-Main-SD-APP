sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/HBox","sap/m/VBox","sap/m/Label","sap/m/Input","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/ui/export/Spreadsheet","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/unified/FileUploader","sap/ui/layout/form/SimpleForm","sap/ui/layout/form/ResponsiveGridLayout"],(e,t,a,n)=>{"use strict";return e.extend("execution.controller.ExecutionOrder",{onInit(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("ExecutionOrder").attachPatternMatched(this._onRouteMatched,this);var t=new sap.ui.model.json.JSONModel({totalValue:0,docNumber:"",itemNumber:"",MainItems:[],Uom:[],ServiceTypes:[],MaterialGroup:[],ServiceNumbers:[]});this.getView().setModel(t);fetch("./odata/v4/sales-cloud/ServiceNumbers").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched ServiceNumbers:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceNumberCode:e.serviceNumberCode,description:e.description}));this.getView().getModel().setProperty("/ServiceNumbers",t);console.log("ServiceNumbers:",t)}}).catch(e=>{console.error("Error fetching ServiceNumbers:",e)});fetch("./odata/v4/sales-cloud/UnitOfMeasurements").then(e=>e.json()).then(e=>{console.log("Fetched UnitOfMeasurements:",e.value);if(e&&e.value){const t=e.value.map(e=>({code:e.code,description:e.description}));this.getView().getModel().setProperty("/Uom",t);console.log("UnitOfMeasurements:",t)}});fetch("./odata/v4/sales-cloud/ServiceTypes").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched ServiceTypes:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceTypeCode:e.serviceTypeCode,description:e.description}));this.getView().getModel().setProperty("/ServiceTypes",t);console.log("ServiceTypes:",t)}}).catch(e=>{console.error("Error fetching ServiceTypes:",e)});fetch("./odata/v4/sales-cloud/MaterialGroups").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched MaterialGroups:",e.value);if(e&&e.value){const t=e.value.map(e=>({materialGroupCode:e.materialGroupCode,description:e.description}));this.getView().getModel().setProperty("/MaterialGroup",t);console.log("MaterialGroups:",t)}}).catch(e=>{console.error("Error fetching MaterialGroups:",e)})},_onRouteMatched:function(e){var t=this.getView();var a=t.getModel();var n=e.getParameter("arguments");var o=n.docNumber;var r=n.itemNumber;console.log("Params:",o,r);a.setProperty("/docNumber",o);a.setProperty("/itemNumber",r);var i=`./odata/v4/sales-cloud/getExecutionOrderMainByReferenceId?referenceId='${o}'&salesOrderItem='${r}'`;fetch(i,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{console.log(e.value);const n=Array.isArray(e.value)?e.value:[];const o=n.reduce((e,t)=>e+Number(t.total||0),0);console.log("Total Value:",o);a.setProperty("/MainItems",e.value);a.setProperty("/totalValue",o);t.byId("executionTable").setModel(a)}).catch(e=>{console.error("Error fetching MainItems",e)})},onSearchItem:function(e){var t=e.getSource().getValue();var a=this.byId("_IDGenTable");var n=a.getBinding("rows");var o=[];if(t&&t.length>0){new sap.ui.model.Filter("MainItemNo",sap.ui.model.FilterOperator.EQ,t);var r=new sap.ui.model.Filter({filters:o,and:false});n.filter([r])}else{n.filter([])}},onSaveDocument:function(){this.byId("_IDGenText1").setText();var e=this.getView().getModel();var t=e.getProperty("/Items");var a=0;t.forEach(e=>{var t=e.AmountPerUnit;var n=e.QTY;var o=t*n;e.Total=o;a+=o});e.setProperty("/Items",t);if(a){this.byId("_IDGenText1").setText(a)}},onPrint:function(){},onExport:function(){var e=this.getView().getModel();var t=[{label:"executionOrderMainCode.",property:"executionOrderMainCode"},{label:"lineNumber",property:"lineNumber"},{label:"serviceNumberCode",property:"serviceNumberCode"},{label:"description",property:"description"},{label:"actualQuantity",property:"actualQuantity"},{label:"unitOfMeasurementCode",property:"unitOfMeasurementCode"},{label:"amountPerUnit",property:"amountPerUnit"},{label:"currencyCode",property:"currencyCode"},{label:"total",property:"total"},{label:"actualQuantity",property:"actualQuantity"},{label:"actualPercentage",property:"actualPercentage"},{label:"overFulfillmentPercent",property:"overFulfillmentPercent"},{label:"unlimitedOverFulfillment",property:"unlimitedOverFulfillment"},{label:"manualPriceEntryAllowed",property:"manualPriceEntryAllowed"},{label:"materialGroupCode",property:"materialGroupCode"},{label:"serviceTypeCode",property:"serviceTypeCode"},{label:"externalServiceNumber",property:"externalServiceNumber"},{label:"serviceText",property:"serviceText"},{label:"lineText",property:"lineText"},{label:"personnelNumberCode",property:"personnelNumberCode"},{label:"lineTypeCode",property:"lineTypeCode"},{label:"biddersLine",property:"biddersLine"},{label:"supplementaryLine",property:"supplementaryLine"},{label:"lotCostOne",property:"lotCostOne"}];var a={workbook:{columns:t},dataSource:e.getProperty("/MainItems"),fileName:"Execution Order Items.xlsx"};var n=new sap.ui.export.Spreadsheet(a);n.build().finally(function(){n.destroy()})},onImport:function(){var e=this;if(!this._oValueHelpDialog){this._oValueHelpDialog=new sap.m.Dialog({title:"Import From:",contentWidth:"400px",contentHeight:"150px",resizable:false,draggable:true,content:new sap.m.HBox({justifyContent:"SpaceAround",alignItems:"Center",class:"sapUiSmallMargin",items:[new sap.m.Button({text:"Quotations",type:"Emphasized",press:function(){e._oValueHelpDialog.close();e._openQuotationsDialog()}}),new sap.m.Button({text:"Models",type:"Emphasized",press:function(){e._oValueHelpDialog.close();e._openModelsDialog()}}),new sap.m.Button({text:"Excel",type:"Emphasized",press:function(){e._oValueHelpDialog.close();e._openExcelUploadDialog()}})]}),beginButton:new sap.m.Button({text:"Cancel",type:"Reject",press:function(){e._oValueHelpDialog.close()}})})}this._oValueHelpDialog.open()},_openQuotationsDialog:function(){var e=this;var t=this.getView();var a=t.getModel();var n=new sap.m.Dialog({title:"Select Rows to Copy",contentWidth:"90%",contentHeight:"70%",resizable:true,draggable:true,buttons:[new sap.m.Button({text:"Copy Selected",type:"Emphasized",press:function(){var t=o.getSelectedItems();if(t.length===0){sap.m.MessageToast.show("Please select at least one row.");return}var r=e.getView();var i=r.getModel();var s=i.getProperty("/MainItems")||[];t.forEach(function(e){var t=e.getBindingContext().getObject();s.push({executionOrderMainCode:t.invoiceMainItemCode,lineNumber:"",serviceNumberCode:t.serviceNumberCode,description:t.description,actualQuantity:t.quantity,unitOfMeasurementCode:t.unitOfMeasurementCode,amountPerUnit:t.amountPerUnit,currencyCode:t.currencyCode,total:t.quantity*t.amountPerUnit})});i.setProperty("/MainItems",s);var l=r.byId("executionTable");if(l&&l.getBinding("rows")){l.getBinding("rows").refresh()}const u=i.getProperty("/MainItems");this.totalValue=u.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);a.setProperty("/totalValue",this.totalValue);console.log(" MainItems after copy:",i.getProperty("/MainItems"));sap.m.MessageToast.show("Selected rows copied to Main Items table!");n.close()}}),new sap.m.Button({text:"Cancel",type:"Reject",press:function(){n.close()}})]});var o=new sap.m.Table({mode:"MultiSelect",inset:false,columns:[new sap.m.Column({header:new sap.m.Label({text:"MainItem.NO"})}),new sap.m.Column({header:new sap.m.Label({text:"Service Number"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"UOM"})}),new sap.m.Column({header:new sap.m.Label({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Label({text:"AmountPerUnit"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})})]});n.addContent(o);$.ajax({url:"./odata/v4/sales-cloud/InvoiceMainItems",method:"GET",success:function(e){var t=new sap.ui.model.json.JSONModel(e.value||e);o.setModel(t);o.bindItems("/",new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{invoiceMainItemCode}"}),new sap.m.Text({text:"{serviceNumberCode}"}),new sap.m.Text({text:"{description}"}),new sap.m.Text({text:"{unitOfMeasurementCode}"}),new sap.m.Text({text:"{quantity}"}),new sap.m.Text({text:"{amountPerUnit}"}),new sap.m.Text({text:"{currencyCode}"})]}))},error:function(){sap.m.MessageToast.show("Failed to fetch quotations data.")}});n.open()},_openModelsDialog:function(){var e=this;var t=new sap.m.Dialog({title:"Models List",contentWidth:"80%",contentHeight:"60%",resizable:true,draggable:true,buttons:[new sap.m.Button({text:"Close",press:function(){t.close()}})]});var a=new sap.m.Table({inset:false,columns:[new sap.m.Column({header:new sap.m.Label({text:"Model ID"})}),new sap.m.Column({header:new sap.m.Label({text:"Model Spec"})}),new sap.m.Column({header:new sap.m.Label({text:"Model Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})}),new sap.m.Column({header:new sap.m.Label({text:"Services"})})]});t.addContent(a);$.ajax({url:"./odata/v4/sales-cloud/ModelSpecifications",method:"GET",success:function(t){console.log("Data:",t);var n=new sap.ui.model.json.JSONModel(t);a.setModel(n);a.bindItems("/value",new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{modelSpecCode}"}),new sap.m.Text({text:"{modelServSpec}"}),new sap.m.Text({text:"{description}"}),new sap.m.Text({text:"{currencyCode}"}),new sap.m.Button({text:"Services",type:"Emphasized",press:function(t){var a=t.getSource().getBindingContext().getProperty("modelSpecCode");e._getModelServices(a)}})]}))},error:function(){sap.m.MessageToast.show("Failed to fetch models data.")}});t.open()},_getModelServices:function(e){var t=this;var a=new sap.m.Dialog({title:"Services for Model: "+e,contentWidth:"70%",contentHeight:"50%",resizable:true,draggable:true,buttons:[new sap.m.Button({text:"Copy Selected",type:"Emphasized",press:function(){var e=n.getSelectedItems();if(e.length===0){sap.m.MessageToast.show("Please select at least one service to copy.");return}var o=t.getView();var r=o.getModel();var i=r.getProperty("/MainItems")||[];e.forEach(function(e){var t=e.getBindingContext().getObject();i.push({serviceNumberCode:t.serviceNumberCode,unitOfMeasurementCode:t.unitOfMeasurementCode,currencyCode:t.currencyCode,description:t.shortText,materialGroupCode:t.materialGroupCode,serviceTypeCode:t.serviceTypeCode,personnelNumberCode:t.personnelNumberCode,lineTypeCode:t.lineTypeCode,totalQuantity:t.quantity,amountPerUnit:t.grossPrice,total:t.netValue,actualQuantity:t.actualQuantity,actualPercentage:t.actualPercentage,overFulfillmentPercentage:t.overFulfilmentPercentage,unlimitedOverFulfillment:t.unlimitedOverFulfillment,manualPriceEntryAllowed:t.manualPriceEntryAllowed,externalServiceNumber:t.externalServiceNumber,serviceText:t.serviceText,lineText:t.lineText,lineNumber:t.lineNumber,biddersLine:t.biddersLine,supplementaryLine:t.supplementaryLine,lotCostOne:t.lotSizeForCostingIsOne})});r.setProperty("/MainItems",i);const s=r.getProperty("/MainItems");this.totalValue=s.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);oModel.setProperty("/totalValue",this.totalValue);o.byId("executionTable").getBinding("rows").refresh();sap.m.MessageToast.show("Selected services copied to Main Items table.");a.close()}}),new sap.m.Button({text:"Close",press:function(){a.close()}})]});var n=new sap.m.Table({mode:"MultiSelect",inset:false,columns:[new sap.m.Column({header:new sap.m.Label({text:"Service ID"})}),new sap.m.Column({header:new sap.m.Label({text:"Service Number"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"UOM"})}),new sap.m.Column({header:new sap.m.Label({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount/Unit"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})})]});a.addContent(n);$.ajax({url:`./odata/v4/sales-cloud/ModelSpecificationsDetails`,method:"GET",success:function(e){var t=new sap.ui.model.json.JSONModel(e);n.setModel(t);n.bindItems("/value",new sap.m.ColumnListItem({type:"Active",cells:[new sap.m.Text({text:"{modelSpecDetailsCode}"}),new sap.m.Text({text:"{serviceText}"}),new sap.m.Text({text:"{shortText}"}),new sap.m.Text({text:"{unitOfMeasurementCode}"}),new sap.m.Text({text:"{quantity}"}),new sap.m.Text({text:"{pricePerUnitOfMeasurement}"}),new sap.m.Text({text:"{currencyCode}"})]}))},error:function(){sap.m.MessageToast.show("Failed to fetch services for this model.")}});a.open()},_openExcelUploadDialog:function(){var e=this;var t;const a=this.getView();const n=a.getModel();var o=new sap.ui.unified.FileUploader({width:"100%",fileType:["xls","xlsx"],sameFilenameAllowed:true,change:function(e){t=e.getParameter("files")[0]}});var r=new sap.m.VBox({items:[o]});var i;var s=new sap.m.Dialog({title:"Import Executions from Excel",contentWidth:"80%",contentHeight:"70%",content:[r],buttons:[new sap.m.Button({text:"Add Selected",type:"Emphasized",press:function(){if(!i)return;const e=n.getProperty("/MainItems")||[];const t=i.getModel().getProperty("/rows");const a=t.filter(e=>e.selected);if(a.length===0){sap.m.MessageToast.show("Please select at least one row!");return}a.forEach(t=>{e.push({executionOrderMainCode:t.executionOrderMainCode||"",lineNumber:t.lineNumber||"",serviceNumberCode:t.serviceNumberCode||"",description:t.description||"",actualQuantity:t.actualQuantity||0,unitOfMeasurementCode:t.unitOfMeasurementCode||"",amountPerUnit:t.amountPerUnit||0,currencyCode:t.currencyCode||"",total:t.total||0,actualPercentage:t.actualPercentage||0,overFulfillmentPercent:t.overFulfillmentPercent||0,unlimitedOverFulfillment:t.unlimitedOverFulfillment||false,manualPriceEntryAllowed:t.manualPriceEntryAllowed||false,materialGroupCode:t.materialGroupCode||"",serviceTypeCode:t.serviceTypeCode||"",externalServiceNumber:t.externalServiceNumber||"",serviceText:t.serviceText||"",lineText:t.lineText||"",personnelNumberCode:t.personnelNumberCode||"",lineTypeCode:t.lineTypeCode||"",biddersLine:t.biddersLine||false,supplementaryLine:t.supplementaryLine||false,lotCostOne:t.lotCostOne||false})});n.setProperty("/MainItems",e);n.refresh(true);sap.m.MessageToast.show("Selected executions added successfully!");s.close()}}),new sap.m.Button({text:"Add All",press:function(){if(!i)return;const e=i.getModel().getProperty("/rows");e.forEach(e=>e.selected=true);i.getModel().refresh();s.getButtons()[0].firePress()}}),new sap.m.Button({text:"Cancel",press:function(){s.close()}})]});var l=function(){if(!t)return;var e=new FileReader;e.onload=function(e){var t=new Uint8Array(e.target.result);var a=XLSX.read(t,{type:"array"});var n=a.Sheets[a.SheetNames[0]];var o=XLSX.utils.sheet_to_json(n);o.forEach(e=>{e.selected=false;e.unlimitedOverFulfillment=e.unlimitedOverFulfillment===true||e.unlimitedOverFulfillment==="true";e.manualPriceEntryAllowed=e.manualPriceEntryAllowed===true||e.manualPriceEntryAllowed==="true";e.biddersLine=e.biddersLine===true||e.biddersLine==="true";e.supplementaryLine=e.supplementaryLine===true||e.supplementaryLine==="true";e.lotCostOne=e.lotCostOne===true||e.lotCostOne==="true"});var s=new sap.ui.model.json.JSONModel({rows:o});i=new sap.m.Table({width:"100%",columns:[new sap.m.Column({header:new sap.m.Text({text:"Select"})}),new sap.m.Column({header:new sap.m.Text({text:"Execution No"})}),new sap.m.Column({header:new sap.m.Text({text:"Line Number"})}),new sap.m.Column({header:new sap.m.Text({text:"Service Code"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})}),new sap.m.Column({header:new sap.m.Text({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Text({text:"UOM"})}),new sap.m.Column({header:new sap.m.Text({text:"Amount Per Unit"})}),new sap.m.Column({header:new sap.m.Text({text:"Total"})}),new sap.m.Column({header:new sap.m.Text({text:"Currency"})}),new sap.m.Column({header:new sap.m.Text({text:"Unlimited Over Fulfillment"})}),new sap.m.Column({header:new sap.m.Text({text:"Manual Price Entry"})})]});i.setModel(s);i.bindItems({path:"/rows",template:new sap.m.ColumnListItem({type:"Inactive",cells:[new sap.m.CheckBox({selected:"{selected}"}),new sap.m.Text({text:"{executionOrderMainCode}"}),new sap.m.Text({text:"{lineNumber}"}),new sap.m.Text({text:"{serviceNumberCode}"}),new sap.m.Text({text:"{description}"}),new sap.m.Text({text:"{actualQuantity}"}),new sap.m.Text({text:"{unitOfMeasurementCode}"}),new sap.m.Text({text:"{amountPerUnit}"}),new sap.m.Text({text:"{total}"}),new sap.m.Text({text:"{currencyCode}"}),new sap.m.CheckBox({selected:"{unlimitedOverFulfillment}"}),new sap.m.CheckBox({selected:"{manualPriceEntryAllowed}"})]})});r.addItem(i)};e.readAsArrayBuffer(t)};o.attachChange(l);s.open()},onEditItem:function(e){var t=e.getSource();var a=t.getBindingContext();if(!a){sap.m.MessageToast.show("No item context found.");return}var n=a.getObject();var o=this.getView().getModel();this._editPath=a.getPath();o.setProperty("/editRow",Object.assign({},n));console.log("Editing item:",n);if(!this._EditItemDialog){var r=new sap.ui.layout.form.SimpleForm({layout:"ResponsiveGridLayout",editable:true,labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:1,emptySpanL:1,emptySpanM:1,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,content:[new sap.m.Label({text:"Service No"}),new sap.m.Input({value:"{/editRow/serviceNumberCode}"}),new sap.m.Label({text:"Description"}),new sap.m.Input({value:"{/editRow/description}"}),new sap.m.Label({text:"Quantity"}),new sap.m.Input({value:"{/editRow/totalQuantity}",type:"Number",liveChange:this._onValueChange.bind(this)}),new sap.m.Label({text:"UOM"}),new sap.m.Select(this.createId("editUOM"),{selectedKey:"{/editRow/unitOfMeasurementCode}",forceSelection:false,items:{path:"/Uom",forceSelection:false,template:new sap.ui.core.Item({key:"{unitOfMeasurementCode}",text:"{description}"})}}),new sap.m.Label({text:"Amount Per Unit"}),new sap.m.Input({value:"{/editRow/amountPerUnit}",type:"Number",liveChange:this._onValueChange.bind(this)}),new sap.m.Label({text:"Over Fulfillment %"}),new sap.m.Input({value:"{/editRow/overFulfillmentPercent}",type:"Number"}),new sap.m.Label({text:"Unlimited Over Fulfillment"}),new sap.m.CheckBox({selected:"{/editRow/unlimitedOverFulfillment}"}),new sap.m.Label({text:"Manual Price Entry Allowed"}),new sap.m.CheckBox({selected:"{/editRow/manualPriceEntryAllowed}"}),new sap.m.Label({text:"Material Group"}),new sap.m.Select(this.createId("editMaterialGroup"),{selectedKey:"{/editRow/materialGroupCode}",forceSelection:false,items:{path:"/MaterialGroup",template:new sap.ui.core.Item({key:"{materialGroupCode}",text:"{description}"})}}),new sap.m.Label({text:"Service Type"}),new sap.m.Select(this.createId("editServiceType"),{selectedKey:"{/editRow/serviceTypeCode}",forceSelection:false,items:{path:"/ServiceTypes",template:new sap.ui.core.Item({key:"{serviceTypeCode}",text:"{description}"})}}),new sap.m.Label({text:"External Service Number"}),new sap.m.Input({value:"{/editRow/externalServiceNumber}"}),new sap.m.Label({text:"Service Text"}),new sap.m.Input({value:"{/editRow/serviceText}"}),new sap.m.Label({text:"Line Text"}),new sap.m.Input({value:"{/editRow/lineText}"}),new sap.m.Label({text:"Personnel Number"}),new sap.m.Input({value:"{/editRow/personnelNumberCode}"}),new sap.m.Label({text:"Line Type"}),new sap.m.Input({value:"{/editRow/lineTypeCode}"}),new sap.m.Label({text:"Bidders Line"}),new sap.m.CheckBox({selected:"{/editRow/biddersLine}"}),new sap.m.Label({text:"Supplementary Line"}),new sap.m.CheckBox({selected:"{/editRow/supplementaryLine}"}),new sap.m.Label({text:"Lot Cost One"}),new sap.m.CheckBox({selected:"{/editRow/lotCostOne}"}),new sap.m.Label({text:"Total"}),new sap.m.Input({value:"{/editRow/total}",liveChange:this._onValueChange.bind(this),editable:false})]});this._EditItemDialog=new sap.m.Dialog({title:"Edit Item",contentWidth:"700px",contentHeight:"auto",resizable:true,draggable:true,content:[r],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:this.onSaveEdit.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._EditItemDialog.close();this._EditItemDialog.destroy();this._EditItemDialog=null}.bind(this)})});this.getView().addDependent(this._EditItemDialog)}this._EditItemDialog.open()},_onValueChange:function(e){var t=this.getView().getModel();var a=e.getSource();var n=e.getParameter("value");var o=a.getBinding("value")&&a.getBinding("value").getPath();if(!o){return}t.setProperty(o,n);var r=t.getProperty("/editRow")||{};var i=parseFloat(r.totalQuantity)||0;var s=parseFloat(r.amountPerUnit)||0;var l=i*s;t.setProperty("/editRow/total",l)},onSaveEdit:function(){var e=this.getView().getModel();var t=e.getProperty("/editRow");var a=parseFloat(t.totalQuantity)||0;var n=parseFloat(t.amountPerUnit)||0;var o=a*n;t.total=o;if(this._editPath){e.setProperty(this._editPath,t)}const r=e.getProperty("/MainItems");this.totalValue=r.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);e.setProperty("/totalValue",this.totalValue);e.refresh(true);this._EditItemDialog.close();this._EditItemDialog.destroy();this._EditItemDialog=null;sap.m.MessageToast.show("Item updated successfully!")},onDeleteItem:function(e){var t=e.getSource().getBindingContext();if(t){var a=t.getPath();var n=this.getView().getModel();var o=n.getProperty(a);sap.m.MessageBox.confirm("Are you sure you want to delete item "+(o.executionOrderMainCode||"")+"?",{title:"Confirm Deletion",onClose:function(e){if(e===sap.m.MessageBox.Action.OK){var t=n.getProperty("/MainItems");var o=parseInt(a.split("/")[2]);if(o>-1){t.splice(o,1);n.setProperty("/MainItems",t);const e=n.getProperty("/MainItems");this.totalValue=e.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);n.setProperty("/totalValue",this.totalValue);n.refresh(true);sap.m.MessageToast.show("Item deleted successfully!")}}}})}},onSaveDocument:function(){const e=this.getView().getModel();const t=e.getProperty("/MainItems")||[];t.forEach(e=>{const t=parseFloat(e.totalQuantity)||0;const a=parseFloat(e.amountPerUnit)||0;e.total=t*a});const a=t.map(t=>({referenceId:e.getProperty("/docNumber")||"",serviceNumberCode:parseInt(t.serviceNumberCode)||0,description:t.description||"",unitOfMeasurementCode:t.unitOfMeasurementCode||"",currencyCode:t.currencyCode||"",totalQuantity:t.totalQuantity||0,remainingQuantity:t.remainingQuantity||0,amountPerUnit:t.amountPerUnit||0,total:t.total||0,actualQuantity:t.actualQuantity||0,actualPercentage:t.actualPercentage||0,overFulfillmentPercent:t.overFulfillmentPercent||0,unlimitedOverFulfillment:t.unlimitedOverFulfillment??true,manualPriceEntryAllowed:t.manualPriceEntryAllowed??true}));const n={executionOrders:a,salesOrder:e.getProperty("/docNumber")||"",salesOrderItem:e.getProperty("/itemNumber")||"",pricingProcedureStep:10,pricingProcedureCounter:1,customerNumber:"120000"};console.log("Payload sent to API:",n);fetch("./odata/v4/sales-cloud/saveOrUpdateExecutionOrders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>{if(!e.ok)throw new Error("Failed to save: "+e.statusText);return e.json()}).then(e=>{console.log(e);sap.m.MessageToast.show("Document saved successfully!")}).catch(e=>{console.error("Error saving document:",e);sap.m.MessageBox.error("Error: "+e.message)})},onAddMianItem:function(){if(!this._AddItemDialog){this._AddItemDialog=new sap.m.Dialog({title:"Add New Item",content:new sap.m.VBox({items:[new sap.m.Label({text:"Service No"}),new sap.m.Input(this.createId("itemServiceNo")),new sap.m.Label({text:"Description"}),new sap.m.Input(this.createId("itemDescription")),new sap.m.Label({text:"QTY"}),new sap.m.Input(this.createId("itemQTY")),new sap.m.Label({text:"UOM"}),new sap.m.Input(this.createId("itemUOM")),new sap.m.Label({text:"Amount Per Unit"}),new sap.m.Input(this.createId("itemAmountPerUnit")),new sap.m.Label({text:"Over Fulfillment %"}),new sap.m.Input(this.createId("itemOverFulf")),new sap.m.Label({text:"Unlimited Over Fulfillment %"}),new sap.m.CheckBox(this.createId("itemUlimitedOFul")),new sap.m.Label({text:"Manual Price Entery Allowd"}),new sap.m.CheckBox(this.createId("itemManualPrice")),new sap.m.Label({text:"Select Material Grp"}),new sap.m.Input(this.createId("itemMaterialGrp")),new sap.m.Label({text:"Service Type"}),new sap.m.Input(this.createId("itemSrvType")),new sap.m.Label({text:"Excternal Service Number"}),new sap.m.Input(this.createId("itemExtSrvNo")),new sap.m.Label({text:"Service Text"}),new sap.m.Input(this.createId("itemSrvText")),new sap.m.Label({text:"Line Text"}),new sap.m.Input(this.createId("itemLineText")),new sap.m.Label({text:"Personnel NR"}),new sap.m.Input(this.createId("itemPersoNr")),new sap.m.Label({text:"Line Type"}),new sap.m.Input(this.createId("itemLineType")),new sap.m.Label({text:"Bidders' Line"}),new sap.m.CheckBox(this.createId("itemBiddersLine")),new sap.m.Label({text:"Supplementary Line"}),new sap.m.CheckBox(this.createId("itemSuppLine")),new sap.m.Label({text:"Lost Cost one"}),new sap.m.CheckBox(this.createId("itemLCO"))]}),beginButton:new sap.m.Button({text:"Add",type:"Emphasized",press:function(){var e=this.getView().getModel().getProperty("/Items");var t={MainItemNo:55,ServiceNo:this.byId("itemServiceNo").getValue(),Description:this.byId("itemDescription").getValue(),QTY:this.byId("itemQTY").getValue(),UOM:this.byId("itemUOM").getValue(),AmountPerUnit:this.byId("itemAmountPerUnit").getValue(),Total:this.byId("itemAmountPerUnit").getValue()*this.byId("itemQTY").getValue(),OverFulfillment:this.byId("itemOverFulf").getValue(),UnlimitedOverFulfillment:this.byId("itemUlimitedOFul").getSelected(),ManualPriceEnteryAllowd:this.byId("itemManualPrice").getSelected(),MaterialGrp:this.byId("itemMaterialGrp").getValue(),ServiceType:this.byId("itemSrvType").getValue(),ExternalServiceNumber:this.byId("itemExtSrvNo").getValue(),ServiceText:this.byId("itemSrvText").getValue(),LineText:this.byId("itemLineText").getValue(),PersonnelNR:this.byId("itemPersoNr").getValue(),LineType:this.byId("itemLineType").getValue(),Biddersline:this.byId("itemBiddersLine").getSelected(),Supplementaryline:this.byId("itemSuppLine").getSelected(),LotCostOne:this.byId("itemLCO").getSelected()};e.push(t);var a=this.getView().getModel();var n=a.setProperty("/Items",e);if(n){sap.m.MessageToast.show("New line has been created successfully!")}this._AddItemDialog.close();this._AddItemDialog.destroy();this._AddItemDialog=null}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._AddItemDialog.close()}.bind(this)})});this.getView().addDependent(this._AddItemDialog)}this._AddItemDialog.open()}})});
//# sourceMappingURL=ExecutionOrder.controller.js.map