sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/m/Dialog","sap/m/Input","sap/m/Button","sap/m/Label","sap/m/VBox","sap/m/HBox","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/ui/export/Spreadsheet","sap/ui/export/library","sap/ui/layout/form/SimpleForm"],function(e,t,o,r,a,s,i,l,n,d,c,u,p,m,g){"use strict";return e.extend("project1.controller.ModelServices",{onInit:function(){var e=new sap.ui.model.json.JSONModel({ModelServices:[],Formulas:[],Currency:[],ModelSpecRec:{},LineTypes:[],UOM:[],personnelNumbers:[],ServiceTypes:[],ServiceNumbers:[],MatGroups:[],FormulaParameters:{},HasSelectedFormula:false,Total:0,SubTotal:0,IsFormulaBasedQuantity:false,ServiceNumbers:[],SelectedServiceNumber:"",SelectedServiceNumberDescription:"",SubDescriptionEditable:true,SelectedFormula:null,totalWithProfit:0,amountPerUnitWithProfit:0});this.getView().setModel(e,"view");fetch("./odata/v4/sales-cloud/ServiceNumbers").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched ServiceNumbers:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceNumberCode:e.serviceNumberCode,description:e.description}));this.getView().getModel().setProperty("/ServiceNumbers",t);console.log("ServiceNumbers:",t)}}).catch(e=>{console.error("Error fetching ServiceNumbers:",e)});fetch("./odata/v4/sales-cloud/PersonnelNumbers").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched personnelNumbers:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceNumberCode:e.serviceNumberCode,description:e.description}));this.getView().getModel().setProperty("/personnelNumbers",t);console.log("personnelNumbers:",t)}}).catch(e=>{console.error("Error fetching ServiceNumbers:",e)});fetch("./odata/v4/sales-cloud/ServiceTypes").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched ServiceTypes:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceNumberCode:e.serviceNumberCode,description:e.description}));this.getView().getModel().setProperty("/ServiceTypes",t);console.log("ServiceTypes:",t)}}).catch(e=>{console.error("Error fetching ServiceNumbers:",e)});fetch("./odata/v4/sales-cloud/LineTypes").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched LineTypes:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceNumberCode:e.serviceNumberCode,description:e.description}));this.getView().getModel().setProperty("/LineTypes",t);console.log("LineTypes:",t)}}).catch(e=>{console.error("Error fetching ServiceNumbers:",e)});fetch("./odata/v4/sales-cloud/Formulas").then(e=>e.json()).then(t=>{const o=Array.isArray(t.value)?t.value:[];console.log("Fetched Formulas:",o);e.setProperty("/Formulas",o);e.refresh(true)}).catch(e=>{console.error("Error fetching Formulas:",e);sap.m.MessageToast.show("Failed to load formulas.")});fetch("./odata/v4/sales-cloud/UnitOfMeasurements").then(e=>e.json()).then(t=>{const o=Array.isArray(t.value)?t.value:[];e.setProperty("/UOM",o);e.refresh(true)});fetch("./odata/v4/sales-cloud/Currencies").then(e=>e.json()).then(t=>{const o=Array.isArray(t.value)?t.value:[];e.setProperty("/Currency",o);e.refresh(true)});fetch("./odata/v4/sales-cloud/MaterialGroups").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched MaterialGroups:",e.value);if(e&&e.value){const t=e.value.map(e=>({materialGroupCode:e.materialGroupCode,description:e.description}));this.getView().getModel().setProperty("/MatGroups",t);console.log("MatGroups:",t)}}).catch(e=>{console.error("Error fetching MaterialGroups:",e)});this.getView().setModel(e);this.getOwnerComponent().getRouter().getRoute("modelServices").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){const t=e.getParameter("arguments").modelSpecCode;console.log("Navigated with modelSpecCode:",t);this.currentModelSpecCode=t;this._loadModelSpecificationDetails(t)},_loadModelSpecificationDetails:function(e){const t=this.getView().getModel("view");const o=`./odata/v4/sales-cloud/ModelSpecifications(${e})?$expand=modelSpecificationsDetails`;console.log(o);fetch(o).then(e=>e.json()).then(o=>{console.log("API Resp:",o);console.log("The Model Specification Details:",o.modelSpecificationsDetails);t.setProperty("/ModelServices",o.modelSpecificationsDetails);console.log("Fetched ModelServices for",e,o.modelSpecificationsDetails);this.updateTotalValue()}).catch(e=>{console.error("Error fetching ModelSpecificationDetails:",e);sap.m.MessageToast.show("Failed to load model details.")})},updateTotalValue:function(){const e=this.getView().getModel();const t=e.getProperty("/ModelServices")||[];const o=t.reduce((e,t)=>e+(parseFloat(t.netValue)||0),0);e.setProperty("/Total",parseFloat(o.toFixed(3)));console.log("Updated Total Value:",o)},onServiceNumberChange:function(e){var t=e.getSource();var o=t.getSelectedItem();var r=this.byId("mainShortTextInput");var a=this.byId("dialogSubDescription");if(o){var s=o.getKey();var i=o.getText();console.log("Selected Key:",s," | Text:",i);var l=this.getView().getModel();l.setProperty("/SelectedServiceNumber",s);l.setProperty("/SelectedServiceNumberDescription",i);r.setValue(i);r.setEditable(false)}else{r.setValue("");r.setEditable(true)}},onInputChange:function(e){var t=this.getView();var o=t.getModel();var r=o.getProperty("/editRow")||{};var a=e.getSource();var s=a.getId();var i=s.includes("editMain");var l=this.getView().getId();var n=i?this.byId("editMainQuantityInput"):sap.ui.getCore().byId(l+"--mainQuantityInput");var d=i?this.byId("editMainAmountPerUnitInput"):sap.ui.getCore().byId(l+"--mainAmountPerUnitInput");var c=i?this.byId("editMainProfitMarginInput"):sap.ui.getCore().byId(l+"--mainProfitMarginInput");var u=parseFloat(n?.getValue())||0;var p=parseFloat(d?.getValue())||0;var m=parseFloat(c?.getValue())||0;console.log("Quantity Calculated:",u);console.log("amount :",p);console.log("Profit Calculated:",m);var g=u*p;var y=m?p*(m/100)+p:0;var v=m?g*(m/100)+g:0;console.log("Total Calculated:",g);if(i&&r){r.total=g.toFixed(3);r.totalWithProfit=v.toFixed(3);r.amountPerUnitWithProfit=y.toFixed(3);o.setProperty("/editRow",r)}else{o.setProperty("/Total",g.toFixed(3));o.setProperty("/totalWithProfit",v.toFixed(3));o.setProperty("/amountPerUnitWithProfit",y.toFixed(3))}},onFormulaSelected:function(e){var t=e.getSource();var o=t.getSelectedKey();var r=this.getView().getModel();var a=r.getProperty("/Formulas")||[];var s=a.find(e=>e.formulaCode===o);r.setProperty("/SelectedFormula",s||null);r.setProperty("/HasSelectedFormula",!!s);var i=this.byId("mainQuantityInput");if(!s){i.setEditable(true);i.setValue("");r.setProperty("/IsFormulaBasedQuantity",false)}else{i.setEditable(false);r.setProperty("/IsFormulaBasedQuantity",true)}},onOpenFormulaDialog:function(){var e=this.getView().getModel();var t=e.getProperty("/SelectedFormula");if(!t){sap.m.MessageToast.show("Please select a formula first.");return}var o=this.byId("formulaDialog");var r=this.byId("formulaParamContainer");r.removeAllItems();var a={};t.parameterIds.forEach(t=>{r.addItem(new sap.m.Label({text:t}));var o=new sap.m.Input({id:t,placeholder:"Enter "+t,liveChange:o=>{a[t]=o.getParameter("value");e.setProperty("/FormulaParameters",a)}});r.addItem(o)});o.open()},_calculateFormulaResult:function(e,t){if(!e||!t)return 0;try{let o=e.formulaLogic;e.parameterIds.forEach(e=>{const r=parseFloat(t[e])||0;o=o.replaceAll(e,r)});o=o.replace(/\^/g,"**");const r=Function('"use strict";return ('+o+")")();return parseFloat(r.toFixed(3))}catch(e){console.error("Error evaluating formula:",e);sap.m.MessageToast.show("Invalid formula or parameters.");return 0}},onFormulaDialogOK:function(){var e=this.getView().getModel();var t=e.getProperty("/SelectedFormula");var o=e.getProperty("/FormulaParameters");var r=this._calculateFormulaResult(t,o);this.byId("formulaDialog").close();var a=this.byId("mainQuantityInput");a.setValue(r);e.setProperty("/IsFormulaBasedQuantity",true);var s=parseFloat(this.byId("mainAmountPerUnitInput").getValue())||0;var i=r*s;this.byId("mainTotalInput").setValue(i.toFixed(3))},onInputChange:function(){var e=parseFloat(this.byId("mainQuantityInput").getValue())||0;var t=parseFloat(this.byId("mainAmountPerUnitInput").getValue())||0;this.byId("mainTotalInput").setValue((e*t).toFixed(3))},onOpenMainDialog:function(){const e=this.getView().getModel();e.setProperty("/newModelService",{});this.byId("addModelServiceDialog").open()},onAddModelSpecDetails:async function(){const e=this.getView();const t=e.getModel("view");const o=this.currentModelSpecCode;if(!o){sap.m.MessageBox.error("Model Specification Code not found! Cannot add detail.");return}const r=t.getProperty("/ModelServices")||[];const a=r.length>0?Math.max(...r.map(e=>parseInt(e.modelSpecDetailsCode)||0)):0;const s=a+1;const i=e.byId("mainServiceTypeSelect");const l=e.byId("mainMatGroupSelect");const n=e.byId("personnelNumber");const d=e.byId("lineTypes");const c=e.byId("mainUOMSelect");const u=e.byId("formulaSelect");const p=e.byId("mainCurrencySelect");var m={modelSpecDetailsCode:s,serviceNumberCode:parseInt(e.byId("mainModelServiceNoSelect").getSelectedKey())||0,noServiceNumber:0,serviceTypeCode:i&&i.getSelectedItem()?i.getSelectedItem().getText():t.getProperty("/newModelService/serviceTypeCode")||"",materialGroupCode:l&&l.getSelectedItem()?l.getSelectedItem().getText():t.getProperty("/newModelService/materialGroupCode")||"",personnelNumberCode:n&&n.getSelectedItem()?n.getSelectedItem().getText():"",unitOfMeasurementCode:c&&c.getSelectedItem()?c.getSelectedItem().getText():"",formulaCode:u&&u.getSelectedItem()?u.getSelectedItem().getText():"",currencyCode:p&&p.getSelectedItem()?p.getSelectedItem().getText():"",lineTypeCode:d&&d.getSelectedItem()?d.getSelectedItem().getText():"",selectionCheckBox:true,lineIndex:"",shortText:e.byId("mainShortTextInput").getValue()||"",quantity:parseFloat(e.byId("mainQuantityInput").getValue())||parseFloat(t.getProperty("/newModelService/quantity"))||0,grossPrice:parseFloat(e.byId("mainAmountPerUnitInput").getValue())||parseFloat(t.getProperty("/newModelService/grossPrice"))||0,overFulfilmentPercentage:parseFloat(e.byId("mainOverFInput").getValue())||parseFloat(t.getProperty("/newModelService/overFulfilmentPercentage"))||0,priceChangedAllowed:e.byId("mainPriceChangeAllowed").getSelected()||t.getProperty("/newModelService/priceChangedAllowed")||false,unlimitedOverFulfillment:e.byId("mainUnlimitedOverF").getSelected()||t.getProperty("/newModelService/unlimitedOverFulfillment")||false,pricePerUnitOfMeasurement:parseFloat(e.byId("mainPricePerUnitInput").getValue())||parseFloat(t.getProperty("/newModelService/pricePerUnitOfMeasurement"))||0,externalServiceNumber:e.byId("mainExternalServiceNo").getValue()||t.getProperty("/newModelService/externalServiceNumber")||"",netValue:parseFloat(e.byId("mainTotalInput").getValue())||0,serviceText:e.byId("mainServiceText").getValue()||t.getProperty("/newModelService/serviceText")||"",lineText:e.byId("mainLineText").getValue()||t.getProperty("/newModelService/lineText")||"",lineNumber:e.byId("_IDGenInput6").getValue()||t.getProperty("/newModelService/lineNumber")||"",alternatives:e.byId("_IDGenInput7").getValue()||t.getProperty("/newModelService/alternatives")||"",biddersLine:e.byId("_IDGenCheckBox").getSelected()||t.getProperty("/newModelService/biddersLine")||false,supplementaryLine:e.byId("_IDGenCheckBox2").getSelected()||t.getProperty("/newModelService/supplementaryLine")||false,lotSizeForCostingIsOne:e.byId("_IDGenCheckBox6").getSelected()||t.getProperty("/newModelService/lotSizeForCostingIsOne")||false,lastChangeDate:(new Date).toISOString().split("T")[0],modelSpecifications_modelSpecCode:parseInt(o),serviceNumber_serviceNumberCode:e.byId("mainModelServiceNoSelect").getSelectedKey()||""};const g=`./odata/v4/sales-cloud/ModelSpecifications(${o})/modelSpecificationsDetails`;try{const t=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!t.ok){const e=await t.text();throw new Error(`HTTP ${t.status}: ${e}`)}sap.m.MessageToast.show("Model Specification Detail added successfully!");this._loadModelSpecificationDetails(o);const r=e.byId("addModelServiceDialog");if(r)r.close()}catch(e){console.error("Error adding Model Specification Detail:",e);sap.m.MessageBox.error("Failed to add Model Specification Detail: "+e.message)}},onDetails:function(e){var t=e.getSource().getParent().getBindingContext();if(t){var o=t.getProperty();var r=this.getView().getModel();r.setProperty("/selectedLine",o);var a=this.getView().byId("detailsDialog");if(a){a.open()}else{console.error("Details dialog not found")}}},onDelete:function(e){var t=e.getSource().getBindingContext();if(!t){sap.m.MessageBox.error("Error: Could not determine the row to delete!");return}var o=t.getPath();var r=this.getView().byId("modelServicesTable");var a=r.getModel()||this.getView().getModel("view")||this.getView().getModel();var s=a.getProperty(o);if(!s){sap.m.MessageBox.error("Error: Could not determine the row to delete!");return}var i=s.modelSpecDetailsCode;if(i===undefined||i===null){sap.m.MessageBox.error("Error: item has no modelSpecDetailsCode!");return}sap.m.MessageBox.confirm("Are you sure you want to delete this record?",{title:"Confirm Deletion",icon:sap.m.MessageBox.Icon.WARNING,actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.YES,onClose:async function(e){if(e!==sap.m.MessageBox.Action.YES)return;try{var t=!isNaN(Number(i));var s=t?i:`'${encodeURIComponent(String(i))}'`;var l=`./odata/v4/sales-cloud/ModelSpecificationsDetails(${s})`;r.setBusy(true);const e=await fetch(l,{method:"DELETE"});r.setBusy(false);if(!e.ok){var n=await e.text().catch(()=>e.statusText);throw new Error("Failed to delete: "+(n||e.statusText))}var d=a.getProperty("/ModelServices")||[];var c=d.findIndex(function(e){return String(e.modelSpecDetailsCode)===String(i)});if(c!==-1){d.splice(c,1);a.setProperty("/ModelServices",d)}else{var u=o.substring(o.lastIndexOf("/")+1);var p=parseInt(u);if(!isNaN(p)&&d[p]){d.splice(p,1);a.setProperty("/ModelServices",d)}else{console.warn("Could not find deleted row in local model to remove; consider reloading server data.")}}sap.m.MessageToast.show("Record deleted successfully.");this.updateTotalValue()}catch(e){r.setBusy(false);console.error("Error deleting record:",e);sap.m.MessageBox.error("Error deleting record: "+e.message)}}.bind(this)})},onPress(){this.getOwnerComponent().getRouter().navTo("addModel")},onOpenAddDialog:function(){console.log("Opening dialog");var e=this.getView().byId("addServiceDialog");if(e){e.open()}else{console.error("Dialog not found")}},_onEditFormulaSelected:function(e,t){const o=this.getView().getModel();const r=t.getObject();const a=e.parameterDescriptions[0];const s=new sap.m.Input({placeholder:`Enter value for ${a}`});const i=new sap.m.Dialog({title:"Enter Parameters",content:[s],beginButton:new sap.m.Button({text:"OK",press:()=>{const e=parseFloat(s.getValue());if(isNaN(e)){sap.m.MessageToast.show("Please enter a valid number");return}const t=22/7*(e*e);r.result=t;o.refresh(true);i.close()}}),endButton:new sap.m.Button({text:"Cancel",press:()=>i.close()})});i.open()},onOpenEditFormulaDialog:function(){const e=this._oEditDialog.getModel("editModel");const t=e.getProperty("/formulaCode");if(!t){sap.m.MessageToast.show("Please select a formula first.");return}const o=this.getView().getModel();const r=o.getProperty("/Formulas")||[];const a=r.find(e=>e.formulaCode===t);if(!a){sap.m.MessageToast.show("Formula not found.");return}const s=new sap.m.VBox;a.parameterDescriptions.forEach((e,t)=>{const o=a.parameterIds[t];s.addItem(new sap.m.Label({text:e}));s.addItem(new sap.m.Input(this.createId("editParam_"+o),{placeholder:`Enter ${e}`}))});const i=new sap.m.Dialog({title:"Enter Formula Parameters",content:[s],beginButton:new sap.m.Button({text:"OK",type:"Emphasized",press:()=>{const t={};a.parameterIds.forEach(e=>{t[e]=this.byId("editParam_"+e).getValue()});const o=this._calculateFormulaResult(a,t);e.setProperty("/quantity",o);sap.m.MessageToast.show("Quantity updated to "+o);i.close()}}),endButton:new sap.m.Button({text:"Cancel",press:()=>i.close()})});this.getView().addDependent(i);i.open()},onEditModelSpecDetails:function(e){var t=e.getSource();var o=t.getBindingContext();if(!o){sap.m.MessageToast.show("No data found for editing.");return}var r=o.getObject();var a=this.getView();if(!this._oEditDialog){this._oEditDialog=new sap.m.Dialog({title:"Edit Model Service",contentWidth:"800px",contentHeight:"80%",resizable:true,draggable:true,content:new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",class:"sapUiSmallMargin",content:[new sap.m.Label({text:"Service.No"}),new sap.m.Input({value:"{editModel>/serviceNumberCode}"}),new sap.m.Label({text:"Short Text"}),new sap.m.Input({value:"{editModel>/shortText}"}),new sap.m.Label({text:"Quantity"}),new sap.m.Input({id:"qtyInput",type:"Number",value:"{editModel>/quantity}",liveChange:this.onEditInputChange.bind(this),valueLiveUpdate:true}),new sap.m.Label({text:"Gross Price"}),new sap.m.Input({id:"grossPriceInput",type:"Number",value:"{editModel>/grossPrice}",liveChange:this.onEditInputChange.bind(this),valueLiveUpdate:true}),new sap.m.Label({text:"Net Value"}),new sap.m.Input({type:"Number",value:"{editModel>/netValue}",editable:false}),new sap.m.Label({text:"Formula"}),new sap.m.Select({change:function(e){console.log("Formula change fired");var t=this._oEditDialog.getModel("editModel");var o=e.getParameter("selectedItem");console.log("Formula selectedItem:",o);var r=o?o.getKey():"";console.log("Setting formula key:",r);t.setProperty("/formulaCode",r);console.log("Model formula value:",t.getProperty("/formulaCode"))}.bind(this),items:{path:"/Formulas",template:new sap.ui.core.Item({key:"{formulaCode}",text:"{description}"})}}),new sap.m.Button({text:"Enter Parameters",press:this.onOpenEditFormulaDialog.bind(this)}),new sap.m.Label({text:"UOM"}),new sap.m.Select({selectedKey:"{editModel>/unitOfMeasurementCode}",change:function(e){console.log("UOM change fired");var t=this._oEditDialog.getModel("editModel");var o=e.getParameter("selectedItem");console.log("UOM selectedItem:",o);var r=o?o.getKey():"";if(!r&&o){r=o.getText();console.log("Fallback UOM key from text:",r)}console.log("Setting UOM key:",r);t.setProperty("/unitOfMeasurementCode",r);console.log("Model UOM value:",t.getProperty("/unitOfMeasurementCode"))}.bind(this),items:{path:"/UOM",template:new sap.ui.core.Item({key:"{code}",text:"{description}"})}}),new sap.m.Label({text:"Currency"}),new sap.m.Select({selectedKey:"{editModel>/currencyCode}",change:function(e){console.log("Currency change fired");var t=this._oEditDialog.getModel("editModel");var o=e.getParameter("selectedItem");console.log("Currency selectedItem:",o);var r=o?o.getKey():"";console.log("Setting currency key:",r);t.setProperty("/currencyCode",r);console.log("Model currency value:",t.getProperty("/currencyCode"))}.bind(this),items:{path:"/Currency",template:new sap.ui.core.Item({key:"{code}",text:"{description}"})}}),new sap.m.Label({text:"OverF.Percentage"}),new sap.m.Input({type:"Number",value:"{editModel>/overFulfilmentPercentage}"}),new sap.m.Label({text:"Price Change Allowed"}),new sap.m.CheckBox({selected:"{editModel>/priceChangedAllowed}"}),new sap.m.Label({text:"Unlimited OverFulfillment"}),new sap.m.CheckBox({selected:"{editModel>/unlimitedOverFulfillment}"}),new sap.m.Label({text:"Price Per Unit Of Measurement"}),new sap.m.Input({type:"Number",value:"{editModel>/pricePerUnitOfMeasurement}"}),new sap.m.Label({text:"Mat Group"}),new sap.m.Select({selectedKey:"{editModel>/materialGroupCode}",items:{path:"/MatGroups",template:new sap.ui.core.Item({key:"{materialGroupCode}",text:"{description}"})}}),new sap.m.Label({text:"Service Type"}),new sap.m.Select({selectedKey:"{editModel>/serviceTypeCode}",items:{path:"/ServiceTypes",template:new sap.ui.core.Item({key:"{serviceTypeCode}",text:"{description}"})}}),new sap.m.Label({text:"External Service No"}),new sap.m.Input({value:"{editModel>/externalServiceNumber}"}),new sap.m.Label({text:"Service Text"}),new sap.m.Input({value:"{editModel>/serviceText}"}),new sap.m.Label({text:"Line Text"}),new sap.m.Input({value:"{editModel>/lineText}"}),new sap.m.Label({text:"Personnel Number"}),new sap.m.Select({selectedKey:"{editModel>/personnelNumberCode}",items:{path:"/personnelNumbers",template:new sap.ui.core.Item({key:"{personnelNumberCode}",text:"{description}"})}}),new sap.m.Label({text:"Line Types"}),new sap.m.Select({selectedKey:"{editModel>/lineTypeCode}",items:{path:"/LineTypes",template:new sap.ui.core.Item({key:"{lineTypeCode}",text:"{description}"})}}),new sap.m.Label({text:"Line Number"}),new sap.m.Input({value:"{editModel>/lineNumber}"}),new sap.m.Label({text:"Alt"}),new sap.m.Input({value:"{editModel>/alternatives}"}),new sap.m.Label({text:"Bidder's Line"}),new sap.m.CheckBox({selected:"{editModel>/biddersLine}"}),new sap.m.Label({text:"Supp.Line"}),new sap.m.CheckBox({selected:"{editModel>/supplementaryLine}"}),new sap.m.Label({text:"Cstg_Ls"}),new sap.m.CheckBox({selected:"{editModel>/lotSizeForCostingIsOne}"})]}),buttons:[new sap.m.Button({text:"Save",type:"Emphasized",press:this.onSaveEditModelService.bind(this)}),new sap.m.Button({text:"Cancel",press:function(){this._oEditDialog.close()}.bind(this)})]});a.addDependent(this._oEditDialog)}var s=a.getModel();if(s){this._oEditDialog.setModel(s)}var i=Object.assign({},r,{formulaCode:""});var l=new sap.ui.model.json.JSONModel(i);this._oEditDialog.setModel(l,"editModel");this._oEditDialog.open()},onSaveEditModelService:async function(){var e=this._oEditDialog;var t=e.getModel("editModel").getData();console.log("Saving data - Formula:",t.formulaCode,"UOM:",t.unitOfMeasurementCode,"Currency:",t.currencyCode);if(!t||!t.modelSpecDetailsCode){sap.m.MessageBox.warning("Missing Model Spec Details Code.");return}try{const{currencyDescription:i,unitOfMeasurementDescription:l,formulaDescription:n,...d}=t;const c=await fetch(`./odata/v4/sales-cloud/ModelSpecificationsDetails(${t.modelSpecDetailsCode})`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!c.ok){throw new Error(`Failed to update: ${c.statusText}`)}var o=this.getView().getModel();var r=o.getProperty("/ModelServices");var a=r.find(e=>e.modelSpecDetailsCode===t.modelSpecDetailsCode);if(a){var s=this.getView().getModel();const e=s.getProperty("/UOM").find(e=>e.code===t.unitOfMeasurementCode);const o=s.getProperty("/Currency").find(e=>e.currencyCode===t.currencyCode);const r=s.getProperty("/Formulas").find(e=>e.formulaCode===t.formulaCode);a.unitOfMeasurementCode=t.unitOfMeasurementCode;a.unitOfMeasurementDescription=e?e.description:"";a.currencyCode=t.currencyCode;a.currencyDescription=o?o.description:"";a.formulaCode=t.formulaCode;a.formulaDescription=r?r.description:"";Object.assign(a,d)}o.refresh(true);this.updateTotalValue();sap.m.MessageToast.show("Model Specification updated successfully!");e.close()}catch(e){sap.m.MessageBox.error("Error updating Model Specification: "+e.message)}},onEditInputChange:function(e){const t=this._oEditDialog.getModel("editModel");if(!t)return;const o=e.getSource();const r=o.getBinding("value").getPath();const a=parseFloat(t.getProperty("/quantity"))||0;const s=parseFloat(t.getProperty("/grossPrice"))||0;const i=a*s;t.setProperty("/netValue",i)},onCloseEditDialog:function(){this.byId("editModelServiceDialog").close()},_openExcelUploadDialogModelSpec:function(){var e=this;var t;var o=new sap.ui.unified.FileUploader({width:"100%",fileType:["xls","xlsx"],sameFilenameAllowed:true,change:function(e){t=e.getParameter("files")[0]}});var r=new sap.m.VBox({items:[o]});var a;var s=new sap.m.Dialog({title:"Import Model Spec from Excel",contentWidth:"80%",contentHeight:"70%",content:[r],buttons:[new sap.m.Button({text:"Add Selected",type:"Emphasized",press:async function(){const t=e.getView();const o=t.getModel("view");const r=e.currentModelSpecCode;if(!r){sap.m.MessageBox.error("Model Specification Code not found!");return}const i=o.getProperty("/ModelServices")||[];const l=a.getModel().getProperty("/rows").filter(e=>e.selected);if(l.length===0){sap.m.MessageToast.show("Please select at least one row!");return}let n=i.length>0?Math.max(...i.map(e=>parseInt(e.modelSpecDetailsCode)||0)):0;for(const e of l){n+=1;const t={modelSpecDetailsCode:n,serviceNumberCode:parseInt(e.serviceNumberCode)||0,noServiceNumber:0,serviceTypeCode:e.serviceTypeCode||"",materialGroupCode:e.materialGroupCode||"",personnelNumberCode:e.personnelNumberCode||"",unitOfMeasurementCode:e.unitOfMeasurementCode||"",formulaCode:e.formulaCode||"",currencyCode:e.currencyCode||"",lineTypeCode:e.lineTypeCode||"",selectionCheckBox:true,lineIndex:"",shortText:e.shortText||"",quantity:parseFloat(e.quantity)||0,grossPrice:parseFloat(e.grossPrice)||0,overFulfilmentPercentage:parseFloat(e.overFulfilmentPercentage)||0,priceChangedAllowed:e.priceChangedAllowed||false,unlimitedOverFulfillment:e.unlimitedOverFulfillment||false,pricePerUnitOfMeasurement:parseFloat(e.pricePerUnitOfMeasurement)||0,externalServiceNumber:e.externalServiceNumber||"",netValue:parseFloat(e.quantity*e.grossPrice)||0,serviceText:e.serviceText||"",lineText:e.lineText||"",lineNumber:e.lineNumber||"",alternatives:e.alternatives||"",biddersLine:e.biddersLine?true:null,supplementaryLine:e.supplementaryLine?true:null,lotSizeForCostingIsOne:e.lotCostOne?true:null,lastChangeDate:(new Date).toISOString().split("T")[0],modelSpecifications_modelSpecCode:parseInt(r),serviceNumber_serviceNumberCode:e.serviceNumberCode||""};const o=`./odata/v4/sales-cloud/ModelSpecifications(${r})/modelSpecificationsDetails`;try{const e=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.text();throw new Error(`HTTP ${e.status}: ${t}`)}i.push(t)}catch(e){console.error("Error adding row:",e);sap.m.MessageToast.show("Failed to add a row: "+e.message)}}o.setProperty("/ModelServices",i);const d=i.reduce((e,t)=>e+(parseFloat(t.netValue)||0),0);o.setProperty("/Total",d);e.getView().byId("modelServicesTable").getModel().refresh(true);sap.m.MessageToast.show("Selected rows added successfully!");s.close()}}),new sap.m.Button({text:"Add All",press:function(){const e=a.getModel().getProperty("/rows");e.forEach(e=>e.selected=true);a.getModel().refresh();s.getButtons()[0].firePress()}}),new sap.m.Button({text:"Cancel",press:function(){s.close()}})]});var i=function(){if(!t)return;var e=new FileReader;e.onload=function(e){var t=new Uint8Array(e.target.result);var o=XLSX.read(t,{type:"array"});var s=o.Sheets[o.SheetNames[0]];var i=XLSX.utils.sheet_to_json(s);i.forEach(e=>e.selected=false);var l=new sap.ui.model.json.JSONModel({rows:i});a=new sap.m.Table({width:"100%",columns:[new sap.m.Column({header:new sap.m.Text({text:"Select"})}),new sap.m.Column({header:new sap.m.Text({text:"Service Number"})}),new sap.m.Column({header:new sap.m.Text({text:"Short Text"})}),new sap.m.Column({header:new sap.m.Text({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Text({text:"Gross Price"})}),new sap.m.Column({header:new sap.m.Text({text:"Currency"})})]});a.setModel(l);a.bindItems({path:"/rows",template:new sap.m.ColumnListItem({type:"Inactive",cells:[new sap.m.CheckBox({selected:"{selected}",select:function(){a.getModel().refresh()}}),new sap.m.Text({text:"{serviceNumberCode}"}),new sap.m.Text({text:"{shortText}"}),new sap.m.Text({text:"{quantity}"}),new sap.m.Text({text:"{grossPrice}"}),new sap.m.Text({text:"{currencyCode}"})]})});r.addItem(a)};e.readAsArrayBuffer(t)};o.attachChange(i);s.open()},onCloseDialog:function(){var e=this.getView().byId("addModelServiceDialog");if(e){e.close();this.getView().byId("dialogLine").setValue("");this.getView().byId("dialogServiceNo").setValue("");this.getView().byId("dialogShortText").setValue("");this.getView().byId("dialogQuantity").setValue("");this.getView().byId("dialogFormula").setValue("");this.getView().byId("dialogFormulaParameters").setValue("");this.getView().byId("dialogGrossPrice").setValue("");this.getView().byId("dialogNetValue").setValue("");this.getView().byId("dialogUnitOfMeasure").setValue("");this.getView().byId("dialogCrcy").setValue("");this.getView().byId("dialogOverFPercentage").setValue("");this.getView().byId("dialogPriceChangeAllowed").setValue("");this.getView().byId("dialogUnlimitedOverF").setValue("");this.getView().byId("dialogPricePerUnitOfMeasurement").setValue("");this.getView().byId("dialogMatGroup").setValue("");this.getView().byId("dialogServiceType").setValue("");this.getView().byId("dialogExternalServiceNo").setValue("");this.getView().byId("dialogServiceText").setValue("");this.getView().byId("dialogLineText").setValue("");this.getView().byId("dialogPersonnelNumber").setValue("");this.getView().byId("dialogLineType").setValue("");this.getView().byId("dialogLineNumber").setValue("");this.getView().byId("dialogAlt").setValue("");this.getView().byId("dialogBiddersLine").setValue("");this.getView().byId("dialogSuppLine").setValue("");this.getView().byId("dialogCstgLs").setValue("")}},onChangeFilterLine:function(e){var t=this.getView().getModel();var o=e.getParameter("value");if(o){var r=t.getProperty("/originalModels").filter(function(e){return e.line.toLowerCase().includes(o.toLowerCase())});t.setProperty("/Models",r)}else{t.setProperty("/Models",t.getProperty("/originalModels"))}},onSearchModelServices:function(e){const t=e.getParameter("query")||e.getParameter("newValue");const o=this.byId("modelServicesTable");const r=o.getBinding("rows");if(!r){console.warn("No binding found for table rows.");return}if(t&&t.trim().length>0){const e=[];e.push(new sap.ui.model.Filter("shortText",sap.ui.model.FilterOperator.Contains,t));const o=parseInt(t,10);if(!isNaN(o)){e.push(new sap.ui.model.Filter("serviceNumberCode",sap.ui.model.FilterOperator.EQ,o))}else{console.log("Query not numeric; skipping serviceNumberCode filter:",t)}if(e.length>0){const t=new sap.ui.model.Filter({filters:e,and:false});r.filter(t);console.log("Applied filter:",t)}else{r.filter([])}}else{r.filter([]);console.log("Cleared filters (empty query).")}},onExportToExcel:function(){var e=this.byId("modelServicesTable");var t=this.getView().getModel();var o=[{label:"line",property:"line"},{label:"serviceNo",property:"serviceNo"},{label:"shortText",property:"shortText"},{label:"quantity",property:"quantity"},{label:"formula",property:"formula"},{label:"formulaParameters",property:"formulaParameters"},{label:"grossPrice",property:"grossPrice"},{label:"netValue",property:"netValue"},{label:"unitOfMeasure",property:"unitOfMeasure"},{label:"crcy",property:"crcy"},{label:"overFPercentage",property:"overFPercentage"},{label:"priceChangeAllowed",property:"priceChangeAllowed"},{label:"unlimitedOverF",property:"unlimitedOverF"},{label:"pricePerUnitOfMeasurement",property:"pricePerUnitOfMeasurement"},{label:"matGroup",property:"matGroup"},{label:"serviceType",property:"serviceType"},{label:"externalServiceNo",property:"externalServiceNo"},{label:"serviceText",property:"serviceText"},{label:"lineText",property:"lineText"},{label:"personnelNumber",property:"personnelNumber"},{label:"lineType",property:"lineType"},{label:"lineNumber",property:"lineNumber"},{label:"alt",property:"alt"},{label:"biddersLine",property:"biddersLine"},{label:"suppLine",property:"suppLine"},{label:"cstgLs",property:"cstgLs"}];var r={workbook:{columns:o},dataSource:t.getProperty("/ModelServices"),fileName:"ModelServices.xlsx"};var a=new sap.ui.export.Spreadsheet(r);a.build().finally(function(){a.destroy()})},onImport:function(){var e=this;var t=document.createElement("input");t.type="file";t.accept=".xlsx, .xls";t.style.display="none";t.addEventListener("change",function(t){var o=t.target.files[0];if(!o){sap.m.MessageToast.show("No file selected!");return}var r=new FileReader;r.onload=function(t){var o=new Uint8Array(t.target.result);var r=XLSX.read(o,{type:"array"});var a=r.SheetNames[0];var s=r.Sheets[a];var i=XLSX.utils.sheet_to_json(s,{defval:""});console.log(i);var l=i.map(function(e){return{line:e.line||"",serviceNo:e.serviceNo||"",shortText:e.shortText||"",quantity:e.quantity||"",formula:e.formula||"",formulaParameters:e.formulaParameters||"",grossPrice:e.grossPrice||"",netValue:e.netValue||"",unitOfMeasure:e.unitOfMeasure||"",crcy:e.crcy||"",overFPercentage:e.overFPercentage||"",priceChangeAllowed:e.priceChangeAllowed||"",unlimitedOverF:e.unlimitedOverF||"",pricePerUnitOfMeasurement:e.pricePerUnitOfMeasurement||"",matGroup:e.matGroup||"",serviceType:e.serviceType||"",externalServiceNo:e.externalServiceNo||"",serviceText:e.serviceText||"",lineText:e.lineText||"",personnelNumber:e.personnelNumber||"",lineType:e.lineType||"",lineNumber:e.lineNumber||"",alt:e.alt||"",biddersLine:e.biddersLine||"",suppLine:e.suppLine||"",cstgLs:e.cstgLs||""}});console.log(l);var n=e.getView().getModel();var d=n.getProperty("/ModelServices")||[];var c=d.concat(l);n.setProperty("/ModelServices",c);sap.m.MessageToast.show("Excel records imported and appended successfully!")};r.readAsArrayBuffer(o)});t.click()}})});
//# sourceMappingURL=ModelServices.controller.js.map