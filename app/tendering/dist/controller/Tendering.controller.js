sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/Input","sap/m/Label","sap/m/VBox","sap/m/MessageToast","sap/m/MessageBox","sap/ui/layout/form/SimpleForm","sap/ui/layout/form/ResponsiveGridLayout"],(e,t,a,o,r,i,s,n,l,u,d)=>{"use strict";return e.extend("tendering.controller.View1",{onInit:function(){var e=new sap.ui.model.json.JSONModel({totalValue:0,docNumber:"",importReady:false,importRows:[],itemNumber:"",MainItems:[],Formulas:[],Currency:[],UOM:[],Total:0,SubTotal:0,IsFormulaBasedQuantity:false,ServiceNumbers:[],SelectedServiceNumber:"",SelectedSubServiceNumber:"",SelectedServiceNumberDescription:"",SelectedSubDescription:"",SelectedSubDescriptionText:"",SubDescriptionEditable:true,SelectedFormula:null,totalWithProfit:0,amountPerUnitWithProfit:0,SelectedSubFormula:null,HasSelectedFormula:false,HasSelectedSubFormula:false,FormulaParameters:{},SubFormulaParameters:{}});this.getView().setModel(e);var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute("tendering").attachPatternMatched(this._onRouteMatched,this);fetch("/odata/v4/sales-cloud/ServiceNumbers").then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("Fetched ServiceNumbers:",e.value);if(e&&e.value){const t=e.value.map(e=>({serviceNumberCode:e.serviceNumberCode,description:e.description}));this.getView().getModel().setProperty("/ServiceNumbers",t);console.log("ServiceNumbers:",t)}}).catch(e=>{console.error("Error fetching ServiceNumbers:",e)});fetch("/odata/v4/sales-cloud/Formulas").then(e=>e.json()).then(t=>{const a=Array.isArray(t.value)?t.value:[];console.log("Fetched Formulas:",a);e.setProperty("/Formulas",a);e.refresh(true)}).catch(e=>{console.error("Error fetching Formulas:",e);sap.m.MessageToast.show("Failed to load formulas.")});fetch("/odata/v4/sales-cloud/UnitOfMeasurements").then(e=>e.json()).then(t=>{const a=Array.isArray(t.value)?t.value:[];e.setProperty("/UOM",a);e.refresh(true)});fetch("/odata/v4/sales-cloud/Currencies").then(e=>e.json()).then(t=>{const a=Array.isArray(t.value)?t.value:[];e.setProperty("/Currency",a);e.refresh(true)})},_onRouteMatched:function(e){var t=this.getView();var a=t.getModel();var o=e.getParameter("arguments");var r=o.docNumber;var i=o.itemNumber;console.log("Params:",r,i);a.setProperty("/docNumber",r);a.setProperty("/itemNumber",i);var s=`/odata/v4/sales-cloud/getInvoiceMainItemByReferenceIdAndItemNumber`;fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referenceId:r,salesQuotationItem:i})}).then(e=>e.json()).then(e=>{console.log(e.value);const o=Array.isArray(e.value)?e.value:[];const r=o.reduce((e,t)=>e+Number(t.total||0),0);console.log("Total Value:",r);a.setProperty("/MainItems",e.value);a.setProperty("/totalValue",r);t.byId("treeTable").setModel(a)}).catch(e=>{console.error("Error fetching MainItems",e)})},onInputChange:function(e){var t=this.getView();var a=t.getModel();var o=a.getProperty("/editRow")||{};var r=e.getSource();var i=r.getId();var s=i.includes("editMain");var n=this.getView().getId();var l=s?this.byId("editMainQuantityInput"):sap.ui.getCore().byId(n+"--mainQuantityInput");var u=s?this.byId("editMainAmountPerUnitInput"):sap.ui.getCore().byId(n+"--mainAmountPerUnitInput");var d=s?this.byId("editMainProfitMarginInput"):sap.ui.getCore().byId(n+"--mainProfitMarginInput");var c=parseFloat(l?.getValue())||0;var m=parseFloat(u?.getValue())||0;var p=parseFloat(d?.getValue())||0;console.log("Quantity Calculated:",c);console.log("amount :",m);console.log("Profit Calculated:",p);var g=c*m;var h=p?m*(p/100)+m:0;var b=p?g*(p/100)+g:0;console.log("Total Calculated:",g);if(s&&o){o.total=g.toFixed(3);o.totalWithProfit=b.toFixed(3);o.amountPerUnitWithProfit=h.toFixed(3);a.setProperty("/editRow",o)}else{a.setProperty("/Total",g.toFixed(3));a.setProperty("/totalWithProfit",b.toFixed(3));a.setProperty("/amountPerUnitWithProfit",h.toFixed(3))}},onServiceNumberChange:function(e){var t=e.getSource();var a=t.getSelectedItem();var o=this.byId("mainDescriptionInput");var r=this.byId("dialogSubDescription");if(a){var i=a.getKey();var s=a.getText();console.log("Selected Key:",i," | Text:",s);var n=this.getView().getModel();n.setProperty("/SelectedServiceNumber",i);n.setProperty("/SelectedServiceNumberDescription",s);o.setValue(s);o.setEditable(false)}else{o.setValue("");o.setEditable(true)}},_calculateFormulaResult:function(e,t){if(!e||!t)return 0;try{let a=e.formulaLogic;console.log("expression",a);e.parameterIds.forEach(e=>{const o=parseFloat(t[e])||0;a=a.replaceAll(e,o)});a=a.replace(/\^/g,"**");const o=Function('"use strict";return ('+a+")")();console.log(parseFloat(o.toFixed(3)));return parseFloat(o.toFixed(3))}catch(e){console.error("Error evaluating formula:",e);sap.m.MessageToast.show("Invalid formula or parameters.");return 0}},onFormulaSelected:function(e){var t=e.getSource();var a=t.getSelectedKey();var o=this.getView().getModel();var r=o.getProperty("/Formulas")||[];var i=r.find(e=>e.formulaCode===a);o.setProperty("/SelectedFormula",i||null);o.setProperty("/HasSelectedFormula",!!i);var s=this.byId("mainQuantityInput");if(!i){s.setEditable(true);o.setProperty("/IsFormulaBasedQuantity",false);s.setValue("")}},onOpenFormulaDialog:function(e){var t=e.getSource();var a=t.getId();console.log("BUTTON PRESS FIRED! Button ID:",a);var o=a.split("--").pop();var s=o==="btnSubParameters"?"sub":"main";console.log("Detected Item Type:",s);var l=this.getView().getModel();var u=s==="sub"?l.getProperty("/SelectedSubFormula"):l.getProperty("/SelectedFormula");console.log("Raw /SelectedSubFormula from model:",l.getProperty("/SelectedSubFormula"));console.log("Raw /SelectedFormula from model:",l.getProperty("/SelectedFormula"));console.log("Formula retrieved for "+s+":",u);if(!u){n.show("Please select a formula first.");return}var d=s==="sub"?this.byId("subFormulaParamContainer"):this.byId("formulaParamContainer");d.removeAllItems();var c={};u.parameterIds.forEach((e,t)=>{c[e]="";d.addItem(new i({text:u.parameterDescriptions[t]}));d.addItem(new r({placeholder:"Enter "+u.parameterDescriptions[t],value:`{/${s==="sub"?"SubFormulaParameters":"FormulaParameters"}/${e}}`}))});l.setProperty(s==="sub"?"/SubFormulaParameters":"/FormulaParameters",c);var m=s==="sub"?this.byId("SubFormulaDialog"):this.byId("formulaDialog");m.open();console.log("Opening dialog for "+s+" with formula:",u)},onFormulaDialogOK:function(){var e=this.getView().getModel();var t=e.getProperty("/SelectedFormula");var a=e.getProperty("/FormulaParameters");e.setProperty("/SelectedFormulaParams",a);this.byId("formulaDialog").close();var o=this._calculateFormulaResult(t,a);console.log("Formula Result:",o);var r=this.byId("mainQuantityInput");r.setValue(o);r.setEditable(false);e.setProperty("/IsFormulaBasedQuantity",true)},onApplyProfitMargin:function(){var e=this.getView();var t=e.getModel();var a=e.byId("treeTable");var o=a.getSelectedIndices();if(o.length===0){sap.m.MessageToast.show("Please select a main item first.");return}var r=o[0];var i=a.getContextByIndex(r).getPath();var s=t.getProperty(i);var n=parseFloat(e.byId("groupInput").getValue())||0;var l=parseFloat(s.quantity)||0;var u=parseFloat(s.amountPerUnit)||0;var d=l*u;var c=u*(n/100)+u;var m=d*(n/100)+d;if(n===0){c=0;m=0}else{var d=l*u;var c=u*(n/100)+u;var m=d*(n/100)+d}s.profitMargin=n;s.total=d.toFixed(3);s.amountPerUnitWithProfit=c.toFixed(3);s.totalWithProfit=m.toFixed(3);t.setProperty(i,s);sap.m.MessageToast.show("Profit margin applied to selected item.")},onSubFormulaDialogOK:function(){var e=this.getView().getModel();var t=e.getProperty("/SubFormulaParameters");e.setProperty("/SelectedSubFormulaParams",t);this.byId("SubFormulaDialog").close()},onSubInputChange:function(){var e=this.getView();var t=e.getModel();var a=e.byId("subQuantityInput").getValue();var o=e.byId("subAmountPerUnitInput").getValue();var r=parseFloat(a)||0;var i=parseFloat(o)||0;var s=r*i;t.setProperty("/SubTotal",s.toFixed(3))},onSubServiceNumberChange:function(e){var t=e.getSource();var a=t.getSelectedItem();var o=this.byId("subDescriptionInput");var r=this.getView().getModel();if(a){var i=a.getKey();var s=a.getText();r.setProperty("/SelectedSubServiceNumber",i);r.setProperty("/SelectedSubDescriptionText",s);r.setProperty("/SubDescriptionEditable",false);o.setValue(s);o.setEditable(false)}else{r.setProperty("/SelectedSubServiceNumber","");r.setProperty("/SelectedSubDescriptionText","");r.setProperty("/SubDescriptionEditable",true);o.setValue("");o.setEditable(true)}},_recalculateSubTotal:function(){var e=this.byId("dialogSubQuantity");var t=this.byId("dialogSubAmountPerUnit");var a=this.byId("dialogSubTotal");var o=parseFloat(e.getValue())||0;var r=parseFloat(t.getValue())||0;var i=o*r;a.setValue(i.toFixed(3))},onSaveDocument:function(){const e=this.getView().getModel();let t=e.getProperty("/MainItems")||[];t=t.map(e=>{const{createdAt:t,modifiedAt:a,createdBy:o,modifiedBy:r,invoiceMainItemCode:i,serviceNumber_serviceNumberCode:s,currencyText:n,formulaText:l,unitOfMeasurementText:u,salesQuotation:d,salesQuotationItem:c,pricingProcedureCounter:m,pricingProcedureStep:p,customerNumber:g,...h}=e;h.totalHeader=parseFloat(Number(h.totalHeader||0).toFixed(3));const b=(e.subItemList||[]).filter(e=>e&&e.serviceNumberCode).map(e=>{const{invoiceMainItemCode:t,createdAt:a,createdBy:o,modifiedAt:r,modifiedBy:i,invoiceSubItemCode:s,mainItem_invoiceMainItemCode:n,serviceNumber_serviceNumberCode:l,...u}=e;return{...u,amountPerUnit:parseFloat(Number(u.amountPerUnit||0).toFixed(3)),total:parseFloat(Number(u.total||0).toFixed(3))}});return{...h,subItemList:b}});const a={salesQuotation:e.getProperty("/docNumber"),salesQuotationItem:e.getProperty("/itemNumber"),pricingProcedureStep:"20",pricingProcedureCounter:"1",customerNumber:"120000",invoiceMainItemCommands:t};console.log("ðŸ“¦ Final payload sent to backend:",JSON.stringify(a,null,2));fetch("/odata/v4/sales-cloud/saveOrUpdateMainItems",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>{if(!e.ok)throw new Error("Failed to save: "+e.statusText);return e.json()}).then(t=>{console.log("ðŸ’¾ Save response:",t);const a=Array.isArray(t.value)?t.value:[];e.setProperty("/MainItems",a);const o=a.reduce((e,t)=>e+Number(t.total||0),0);e.setProperty("/totalValue",o);e.refresh(true);sap.m.MessageToast.show("Document saved successfully!")}).catch(e=>{console.error("âŒ Error saving MainItem:",e);sap.m.MessageBox.error("Error: "+e.message)})},onOpenSubDialogForRow:function(e){const t=e.getSource().getBindingContext();const a=t.getObject();if(!a.subItemList){sap.m.MessageToast.show("You can only add subitems under a main item!");return}this._selectedParent=a;this.byId("parentMainItemNoInput").setValue(a.MainItemNo||"");this.byId("subItemNoInput").setValue("");this.byId("subServiceNoInput").setSelectedKey("");this.byId("subDescriptionInput").setValue("");this.byId("subQuantityInput").setValue("");this.byId("subUOMInput").setSelectedKey("");this.byId("subFormulaSelect").setSelectedKey("");this.byId("subAmountPerUnitInput").setValue("");this.byId("subCurrencyInput").setSelectedKey("");this.byId("subTotalInput").setValue("");this.getView().getModel().setProperty("/HasSelectedSubFormula",false);this.getView().getModel().setProperty("/SelectedSubFormulaParams",{});this.getView().getModel().setProperty("/SelectedSubServiceNumber","");this.getView().getModel().setProperty("/SelectedSubDescriptionText","");this.getView().getModel().setProperty("/SubDescriptionEditable",true);this.getView().getModel().setProperty("/SubTotal","0");this.byId("addSubDialog").open()},_calculateTotals:function(e,t=false){if(!e)return;const a=parseFloat(e.quantity)||0;const o=parseFloat(e.amountPerUnit)||0;const r=parseFloat(e.profitMargin)||0;if(t){e.total=(a*o).toFixed(3);return}const i=a*o;const s=o+o*r/100;const n=a*s;e.total=i.toFixed(3);e.amountPerUnitWithProfit=s.toFixed(3);e.totalWithProfit=n.toFixed(3)},_recalculateMainFromSubitems:function(e){if(!e||!Array.isArray(e.subItemList))return;const t=e.subItemList.reduce((e,t)=>{const a=parseFloat(t.total)||0;return e+a},0);e.amountPerUnit=t.toFixed(3);const a=parseFloat(e.quantity)||0;const o=parseFloat(e.profitMargin)||0;const r=t;const i=a*r;e.total=i.toFixed(3);if(o>0){var s=r*(o/100)+r;var n=i*(o/100)+i;e.amountPerUnitWithProfit=s.toFixed(3);e.totalWithProfit=n.toFixed(3)}else{e.amountPerUnitWithProfit=0;e.totalWithProfit=0}},onEditRow:function(e){var t=e.getSource();var a=t.getBindingContext();if(!a){sap.m.MessageToast.show("No item context found.");return}var o=a.getObject();var r=this.getView().getModel();this._editPath=a.getPath();r.setProperty("/editRow",Object.assign({},o));console.log("Editing item:",o);var i=!!o.invoiceSubItemCode;if(i){if(!this._oEditSubDialog){var s=new sap.ui.layout.form.SimpleForm({layout:"ResponsiveGridLayout",editable:true,labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:1,emptySpanL:1,emptySpanM:1,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,content:[new sap.m.Label({text:"Service No"}),new sap.m.Select(this.createId("editSubServiceNo"),{selectedKey:"{/editRow/serviceNumberCode}",items:{path:"/ServiceNumbers",template:new sap.ui.core.Item({key:"{serviceNumberCode}",text:"{description}"})}}),new sap.m.Label({text:"Description"}),new sap.m.Input({value:"{/editRow/description}"}),new sap.m.Label({text:"Quantity"}),new sap.m.Input({value:"{/editRow/quantity}",type:"Number",liveChange:this._onValueChange.bind(this)}),new sap.m.Label({text:"UOM"}),new sap.m.Select(this.createId("editSubUOM"),{selectedKey:"{/editRow/unitOfMeasurementCode}",items:{path:"/UOM",template:new sap.ui.core.Item({key:"{unitOfMeasurementCode}",text:"{description}"})}}),new sap.m.Label({text:"Formula"}),new sap.m.Select(this.createId("editSubFormula"),{selectedKey:"{/editRow/formulaCode}",forceSelection:false,items:[new sap.ui.core.Item({key:"",text:"â€” Select Formula â€”"}),new sap.ui.core.Item({key:"{formulaCode}",text:"{description}"})],items:{path:"/Formulas",templateShareable:false,template:new sap.ui.core.Item({key:"{formulaCode}",text:"{description}"})}}),new sap.m.Button(this.createId("btnEditEnterParams"),{text:"Enter Parameters",enabled:"{/HasSelectedFormula}",press:this.onOpenEditFormulaDialog.bind(this)}),new sap.m.Label({text:"Amount Per Unit"}),new sap.m.Input({value:"{/editRow/amountPerUnit}",type:"Number",liveChange:this._onValueChange.bind(this)}),new sap.m.Label({text:"Currency"}),new sap.m.Select(this.createId("editSubCurrency"),{selectedKey:"{/editRow/currencyCode}",items:{path:"/Currency",template:new sap.ui.core.Item({key:"{currencyCode}",text:"{description}"})}}),new sap.m.Label({text:"Total"}),new sap.m.Input({value:"{/editRow/total}",editable:false})]});this._oEditSubDialog=new sap.m.Dialog({title:"Edit Sub Item",contentWidth:"700px",contentHeight:"auto",resizable:true,draggable:true,content:[s],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:this.onSaveEdit.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._oEditSubDialog.close();this._oEditSubDialog.destroy();this._oEditSubDialog=null}.bind(this)})});this.getView().addDependent(this._oEditSubDialog)}this._oEditSubDialog.open()}else{if(!this._oEditMainDialog){var n=new sap.ui.layout.form.SimpleForm({layout:"ResponsiveGridLayout",editable:true,labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:1,emptySpanL:1,emptySpanM:1,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,content:[new sap.m.Label({text:"Service No"}),new sap.m.Select(this.createId("editMainServiceNo"),{selectedKey:"{/editRow/serviceNumberCode}",items:{path:"/ServiceNumbers",template:new sap.ui.core.Item({key:"{serviceNumberCode}",text:"{description}"})}}),new sap.m.Label({text:"Description"}),new sap.m.Input({value:"{/editRow/description}"}),new sap.m.Label({text:"Quantity"}),new sap.m.Input(this.createId("editMainQuantityInput"),{value:"{/editRow/quantity}",type:"Number",liveChange:this.onInputChange.bind(this)}),new sap.m.Label({text:"UOM"}),new sap.m.Select(this.createId("editMainUOMSelect"),{selectedKey:"{/editRow/unitOfMeasurementCode}",items:{path:"/UOM",template:new sap.ui.core.Item({key:"{unitOfMeasurementCode}",text:"{description}"})}}),new sap.m.Label({text:"Formula"}),new sap.m.Select(this.createId("editFormulaSelect"),{selectedKey:"{/editRow/formulaCode}",change:this._onEditFormulaSelected.bind(this),items:{path:"/Formulas",template:new sap.ui.core.Item({key:"{formulaCode}",text:"{description}"})}}),new sap.m.Button(this.createId("btnEditEnterParams"),{text:"Enter Parameters",enabled:"{= ${/editRow/formulaCode} ? true : false }",press:this.onOpenEditFormulaDialog.bind(this)}),new sap.m.Label({text:"Amount Per Unit"}),new sap.m.Input(this.createId("editMainAmountPerUnitInput"),{value:"{/editRow/amountPerUnit}",type:"Number",liveChange:this.onInputChange.bind(this)}),new sap.m.Label({text:"Currency"}),new sap.m.Select(this.createId("editMainCurrencySelect"),{selectedKey:"{/editRow/currencyCode}",items:{path:"/Currency",template:new sap.ui.core.Item({key:"{currencyCode}",text:"{description}"})}}),new sap.m.Label({text:"Total"}),new sap.m.Input(this.createId("editMainTotalInput"),{value:"{/editRow/total}",editable:false}),new sap.m.Label({text:"Profit Margin"}),new sap.m.Input(this.createId("editMainProfitMarginInput"),{value:"{/editRow/profitMargin}",type:"Number",liveChange:this.onInputChange.bind(this)}),new sap.m.Label({text:"Amount Per Unit with Profit"}),new sap.m.Input(this.createId("editMainAmountPerUnitWithProfitInput"),{value:"{/editRow/amountPerUnitWithProfit}",editable:false}),new sap.m.Label({text:"Total with Profit"}),new sap.m.Input(this.createId("editMainTotalWithProfitInput"),{value:"{/editRow/totalWithProfit}",editable:false})]});this._oEditMainDialog=new sap.m.Dialog({title:"Edit Main Item",contentWidth:"700px",contentHeight:"auto",resizable:true,draggable:true,content:[n],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:this.onSaveEdit.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._oEditMainDialog.close();this._oEditMainDialog.destroy();this._oEditMainDialog=null}.bind(this)})});this.getView().addDependent(this._oEditMainDialog)}this._oEditMainDialog.open()}},_onValueChange:function(e){const t=this.getView().getModel();const a=t.getProperty("/editRow")||{};const o=parseFloat(e.getParameter("value"));const r=e.getSource().getBindingInfo("value").parts[0].path.split("/").pop();a[r]=isNaN(o)?" ":o;const i=parseFloat(a.quantity);const s=parseFloat(a.amountPerUnit);const n=parseFloat(a.profitMargin);const l=isNaN(i)?0:i;const u=isNaN(s)?0:s;const d=isNaN(n)?0:n;const c=!!a.invoiceSubItemCode;if(c){a.total=(l*u).toFixed(3)}else{const e=l*u;const t=u+u*d/100;const o=l*t;a.total=e.toFixed(3);a.amountPerUnitWithProfit=t.toFixed(3);a.totalWithProfit=o.toFixed(3)}t.setProperty("/editRow",a)},onSaveEdit:function(){var e=this.getView();var t=e.getModel();var a=t.getProperty("/editRow");var o=!!a.invoiceSubItemCode;var r=o?e.byId("editSubCurrency"):e.byId("editMainCurrencySelect");var i=o?e.byId("editSubUOM"):e.byId("editMainUOMSelect");var s=o?e.byId("editSubFormula"):e.byId("editFormulaSelect");var n=r&&r.getSelectedItem();if(n){a.currencyCode=n.getText();console.log("Edited Currency",a.currencyCode)}else{a.currencyCode=""}var l=i&&i.getSelectedItem();if(l){a.unitOfMeasurementCode=l.getText();console.log("Edited unitOfMeasurementCode",a.unitOfMeasurementCode)}else{a.unitOfMeasurementCode=""}var u=s&&s.getSelectedItem();if(u){a.formulaCode=u.getText();console.log("Edited formulaCode",a.formulaCode)}else{a.formulaCode=""}t.setProperty(this._editPath,a);t.refresh(true);if(o){const e=this._editPath.split("/");const a=parseInt(e[2]);const o=t.getProperty(`/MainItems/${a}`);if(o){this._recalculateMainFromSubitems(o);t.setProperty(`/MainItems/${a}`,o)}}const d=t.getProperty("/MainItems")||[];const c=d.reduce((e,t)=>e+parseFloat(t.total||0),0);t.setProperty("/totalValue",c);sap.m.MessageToast.show("The line was updated successfully");if(this._oEditSubDialog&&this._oEditSubDialog.isOpen()){this._oEditSubDialog.close();this._oEditSubDialog.destroy();this._oEditSubDialog=null}if(this._oEditMainDialog&&this._oEditMainDialog.isOpen()){this._oEditMainDialog.close();this._oEditMainDialog.destroy();this._oEditMainDialog=null}},_onEditFormulaSelected:function(e,t){const a=this.getView().getModel();const o=t.getObject();const r=e.parameterDescriptions[0];const i=new sap.m.Input({placeholder:`Enter value for ${r}`});const s=new sap.m.Dialog({title:"Enter Parameters",content:[i],beginButton:new sap.m.Button({text:"OK",press:()=>{const e=parseFloat(i.getValue());if(isNaN(e)){sap.m.MessageToast.show("Please enter a valid number");return}const t=22/7*(e*e);o.result=t;a.refresh(true);s.close()}}),endButton:new sap.m.Button({text:"Cancel",press:()=>s.close()})});s.open()},onOpenEditFormulaDialog:function(){const e=this.getView().getModel();const t=e.getProperty("/editRow/formulaCode");if(!t){sap.m.MessageToast.show("Please select a formula first.");return}const a=e.getProperty("/Formulas")||[];const o=a.find(e=>e.formulaCode===t);if(!o){sap.m.MessageToast.show("Formula not found.");return}const r=new sap.m.VBox({id:this.createId("editFormulaParamBox")});o.parameterDescriptions.forEach((e,t)=>{const a=o.parameterIds[t];r.addItem(new sap.m.Label({text:e}));r.addItem(new sap.m.Input(this.createId("editParam_"+a),{placeholder:`Enter ${e}`}))});const i=new sap.m.Dialog({title:"Enter Formula Parameters",content:[r],beginButton:new sap.m.Button({text:"OK",type:"Emphasized",press:()=>{const t={};o.parameterIds.forEach(e=>{t[e]=this.byId("editParam_"+e).getValue()});const a=this._calculateFormulaResult(o,t);e.setProperty("/editRow/quantity",a);sap.m.MessageToast.show("Quantity updated to "+a);i.close()}}),endButton:new sap.m.Button({text:"Cancel",press:()=>i.close()})});this.getView().addDependent(i);i.open()},onAddSubItem:function(){var e=this.getView();var t=e.getModel();var a=this.byId("subDescriptionInput").getValue();var o=this.byId("subQuantityInput").getValue();if(!a.trim()){sap.m.MessageToast.show("Description is required.");return}if(!o||parseFloat(o)<=0){sap.m.MessageToast.show("Quantity must be a positive number.");return}var r=this.byId("subServiceNoInput").getSelectedItem();var i=this.byId("subUOMInput").getSelectedItem();var s=this.byId("subFormulaSelect").getSelectedItem();var n=this.byId("subCurrencyInput").getSelectedItem();var l={serviceNumberCode:r?r.getText():"",description:a,quantity:parseFloat(o)||0,unitOfMeasurementCode:i?i.getText():"",formulaCode:s?s.getText():"",amountPerUnit:parseFloat(this.byId("subAmountPerUnitInput").getValue())||0,currencyCode:n?n.getText():"",total:parseFloat(this.byId("subTotalInput").getValue())||0};console.log("Adding subitem:",l);if(!this._selectedParent.subItemList){this._selectedParent.subItemList=[]}this._selectedParent.subItemList.push(l);this._recalculateMainFromSubitems(this._selectedParent);t.refresh(true);this.byId("addSubDialog").close();sap.m.MessageToast.show("Subitem added successfully!")},onDeleteRow:function(e){const t=this.getView().getModel();const a=e.getSource().getBindingContext();const o=a.getObject();const r=a.getPath();sap.m.MessageBox.confirm("Are you sure you want to delete this item?",{title:"Confirm Deletion",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:e=>{if(e===sap.m.MessageBox.Action.YES){if(o.invoiceSubItemCode){const e=r.split("/");const a=parseInt(e[2]);const o=parseInt(e[4]);const i=t.getProperty("/MainItems");i[a].subItemList.splice(o,1);sap.m.MessageToast.show("SubItem deleted successfully")}else{const e=parseInt(r.split("/")[2]);const a=t.getProperty("/MainItems");a.splice(e,1);sap.m.MessageToast.show("MainItem deleted successfully")}t.refresh()}}})},onAddMainItem:function(){const e=this.getView();const t=e.getModel();var a=e.byId("mainUOMSelect");var o=e.byId("formulaSelect");var r=e.byId("mainCurrencySelect");const i={salesQuotation:t.getProperty("/docNumber"),salesQuotationItem:t.getProperty("/itemNumber"),pricingProcedureStep:"1",pricingProcedureCounter:"10",customerNumber:"120000",invoiceMainItemCode:Date.now(),serviceNumberCode:t.getProperty("/SelectedServiceNumberDescription")||"",description:e.byId("mainDescriptionInput").getValue()||"",quantity:parseFloat(e.byId("mainQuantityInput").getValue())||0,unitOfMeasurementCode:a&&a.getSelectedItem()?a.getSelectedItem().getText():"",formulaCode:o&&o.getSelectedItem()?o.getSelectedItem().getText():"",currencyCode:r&&r.getSelectedItem()?r.getSelectedItem().getText():"",amountPerUnit:parseFloat(e.byId("mainAmountPerUnitInput").getValue())||0,total:parseFloat(e.byId("mainTotalInput").getValue())||0,profitMargin:parseFloat(e.byId("mainProfitMarginInput").getValue())||0,amountPerUnitWithProfit:parseFloat(e.byId("mainAmountPerUnitWithProfitInput").getValue())||0,totalWithProfit:parseFloat(e.byId("mainTotalWithProfitInput").getValue())||0,subItemList:[]};const s=t.getProperty("/MainItems")||[];s.push(i);t.setProperty("/MainItems",s);t.refresh(true);this.byId("addMainDialog").close();sap.m.MessageToast.show("Main item added successfully!")},onSearch:function(e){const t=this.byId("treeTable");const a=t.getBinding("rows");const o=e.getParameter("query")||e.getSource().getValue();if(!a){console.warn("Table binding not found.");return}if(!o){a.filter([]);return}const r=[new sap.ui.model.Filter("serviceNumberCode",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("quantity",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("unitOfMeasurementCode",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("formulaCode",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("currencyCode",sap.ui.model.FilterOperator.Contains,o)];const i=new sap.ui.model.Filter({filters:r,and:false});a.filter(i)},onImport:function(){this.byId("importDialog").open();this.byId("importStatus").setText("");this.byId("fileUploader").clear();this.getView().getModel().setProperty("/importReady",false)},_openExcelUploadDialogTendering:function(){var e=this;var t;const a=this.getView();const o=a.getModel();var r=new sap.ui.unified.FileUploader({width:"100%",fileType:["xls","xlsx"],sameFilenameAllowed:true,change:function(e){t=e.getParameter("files")[0]}});var i=new sap.m.VBox({items:[r]});var s;var n=new sap.m.Dialog({title:"Import Main Items from Excel",contentWidth:"80%",contentHeight:"70%",content:[i],buttons:[new sap.m.Button({text:"Add Selected",type:"Emphasized",press:function(){const e=o.getProperty("/MainItems")||[];const t=s.getModel().getProperty("/rows");const a=t.filter(e=>e.selected);if(a.length===0){sap.m.MessageToast.show("Please select at least one row!");return}a.forEach(t=>{const a={salesQuotation:o.getProperty("/docNumber"),salesQuotationItem:o.getProperty("/itemNumber"),pricingProcedureStep:"1",pricingProcedureCounter:"10",customerNumber:"120000",invoiceMainItemCode:Date.now(),serviceNumberCode:t["Service No"]||"",description:t["Description"]||"",quantity:parseFloat(t["Quantity"])||0,unitOfMeasurementCode:t["UOM"]||"",formulaCode:t["Formula"]||"",currencyCode:t["Currency"]||"",amountPerUnit:parseFloat(t["Amount Per Unit"])||0,total:parseFloat(t["Total"])||0,profitMargin:parseFloat(t["Profit Margin"])||0,amountPerUnitWithProfit:parseFloat(t["Amount Per Unit with Profit"])||0,totalWithProfit:parseFloat(t["Total with Profit"])||0,subItemList:[]};e.push(a)});o.setProperty("/MainItems",e);o.refresh(true);sap.m.MessageToast.show("Main items added successfully!");n.close()}}),new sap.m.Button({text:"Add All",press:function(){const e=s.getModel().getProperty("/rows");e.forEach(e=>e.selected=true);s.getModel().refresh();n.getButtons()[0].firePress()}}),new sap.m.Button({text:"Cancel",press:function(){n.close()}})]});var l=function(){if(!t)return;var e=new FileReader;e.onload=function(e){var t=new Uint8Array(e.target.result);var a=XLSX.read(t,{type:"array"});var o=a.Sheets[a.SheetNames[0]];var r=XLSX.utils.sheet_to_json(o);r.forEach(e=>e.selected=false);var n=new sap.ui.model.json.JSONModel({rows:r});s=new sap.m.Table({width:"100%",columns:[new sap.m.Column({header:new sap.m.Text({text:"Select"})}),new sap.m.Column({header:new sap.m.Text({text:"Service No"})}),new sap.m.Column({header:new sap.m.Text({text:"Description"})}),new sap.m.Column({header:new sap.m.Text({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Text({text:"UOM"})}),new sap.m.Column({header:new sap.m.Text({text:"Formula"})}),new sap.m.Column({header:new sap.m.Text({text:"Parameters"})}),new sap.m.Column({header:new sap.m.Text({text:"Currency"})}),new sap.m.Column({header:new sap.m.Text({text:"Amount Per Unit"})}),new sap.m.Column({header:new sap.m.Text({text:"Total"})}),new sap.m.Column({header:new sap.m.Text({text:"Profit Margin"})}),new sap.m.Column({header:new sap.m.Text({text:"Amount Per Unit with Profit"})}),new sap.m.Column({header:new sap.m.Text({text:"Total with Profit"})})]});s.setModel(n);s.bindItems({path:"/rows",template:new sap.m.ColumnListItem({type:"Inactive",cells:[new sap.m.CheckBox({selected:"{selected}"}),new sap.m.Text({text:"{Service No}"}),new sap.m.Text({text:"{Description}"}),new sap.m.Text({text:"{Quantity}"}),new sap.m.Text({text:"{UOM}"}),new sap.m.Text({text:"{Formula}"}),new sap.m.Text({text:"{Parameters}"}),new sap.m.Text({text:"{Currency}"}),new sap.m.Text({text:"{Amount Per Unit}"}),new sap.m.Text({text:"{Total}"}),new sap.m.Text({text:"{Profit Margin}"}),new sap.m.Text({text:"{Amount Per Unit with Profit}"}),new sap.m.Text({text:"{Total with Profit}"})]})});i.addItem(s)};e.readAsArrayBuffer(t)};r.attachChange(l);n.open()},onFileChange:function(e){var t=e.getSource();var a=t.$().find('input[type="file"]');if(a.length===0){sap.m.MessageToast.show("File input not found. Please try selecting again.");return}var o=a[0].files[0];if(!o||!o.name.endsWith(".xlsx")){sap.m.MessageToast.show("Please select a valid .xlsx file.");return}var r=new FileReader;r.onload=function(e){var t=new Uint8Array(e.target.result);var a=XLSX.read(t,{type:"array"});var o=a.Sheets[a.SheetNames[0]];var r=XLSX.utils.sheet_to_json(o,{header:1});if(r.length<2){sap.m.MessageToast.show("Excel file is empty or has no data rows.");return}var i=r[0];var s=["Service No","Description","Quantity","UOM","Amount Per Unit","Currency"];var n=s.every(function(e){return i.includes(e)});if(!n){sap.m.MessageToast.show("Excel must have headers: "+s.join(", "));return}var l=r.slice(1).map(function(e,t){var a={};i.forEach(function(t,o){a[t]=e[o]||""});a.Quantity=parseFloat(a.Quantity)||0;a["Amount Per Unit"]=parseFloat(a["Amount Per Unit"])||0;a.Total=(a.Quantity*a["Amount Per Unit"]).toFixed(3);return{serviceNumberCode:a["Service No"]||"",description:a.Description||"",quantity:a.Quantity.toFixed(3),unitOfMeasurementCode:a.UOM||"",amountPerUnit:a["Amount Per Unit"].toFixed(3),total:a.Total,currencyCode:a.Currency||"",formulaCode:"",profitMargin:"0.000",amountPerUnitWithProfit:"0.000",totalWithProfit:"0.000",subItemList:[]}}).filter(function(e){return e.description.trim()&&e.quantity>0});if(l.length===0){sap.m.MessageToast.show("No valid rows to import.");return}this.getView().getModel().setProperty("/importRows",l);this.getView().getModel().setProperty("/importReady",true);this.byId("importStatus").setText(l.length+" valid rows ready to import.")}.bind(this);r.readAsArrayBuffer(o)},onImportData:function(){var e=this.getView().getModel();var t=e.getProperty("/importRows")||[];var a=e.getProperty("/MainItems")||[];a=a.concat(t);var o=a.reduce(function(e,t){return parseFloat((e+parseFloat(t.total||"0.000")).toFixed(3))},0);e.setProperty("/MainItems",a);e.setProperty("/totalValue",o.toFixed(3));e.refresh(true);this.onCloseImportDialog();sap.m.MessageToast.show(t.length+" items imported successfully!")},onExport:function(){this.byId("exportChoiceDialog").open()},onCloseExportDialog:function(){this.byId("exportChoiceDialog").close()},onExport:function(){var e=this._flattenDataForExport();if(e.length===0){sap.m.MessageToast.show("No data to export.");return}var t=Object.keys(e[0]);var a=[t];var o=e.map(function(e){return t.map(function(t){return e[t]})});var r=XLSX.utils.aoa_to_sheet(a.concat(o));var i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,r,"Tendering Items");XLSX.writeFile(i,"Tendering_Export_"+(new Date).toISOString().slice(0,10)+".xlsx");sap.m.MessageToast.show(e.length+" rows exported to Excel.");this.onCloseExportDialog()},onExportPDF:function(){var e=this._flattenDataForExport();if(e.length===0){sap.m.MessageToast.show("No data to export.");return}var t=Object.keys(e[0]);var a=e.map(function(e){return t.map(function(t){return e[t]})});var{jsPDF:o}=window.jspdf;var r=new o("l","mm","a4");r.text("Tendering Items Export - "+(new Date).toLocaleDateString(),14,20);r.autoTable({head:[t],body:a,startY:30,theme:"grid",styles:{fontSize:8,cellPadding:2},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},columnStyles:{0:{cellWidth:20},1:{cellWidth:40},2:{cellWidth:50}},margin:{top:30,left:10,right:10}});var i=this.getView().getModel().getProperty("/totalValue")||"0.000";r.text("Total Value: "+i+" SAR",14,r.lastAutoTable.finalY+10);r.save("Tendering_Export_"+(new Date).toISOString().slice(0,10)+".pdf");sap.m.MessageToast.show(e.length+" rows exported to PDF.");this.onCloseExportDialog()},_flattenDataForExport:function(){var e=this.getView().getModel();var t=e.getProperty("/MainItems")||[];var a=[];t.forEach(function(e,t){a.push({Type:"Main","Service No":e.serviceNumberCode||"",Description:e.description||"",Quantity:e.quantity||"0.000",UOM:e.unitOfMeasurementCode||"",Formula:e.formulaCode||"",Parameters:e.parameters?Object.keys(e.parameters).join(", "):"None",Currency:e.currencyCode||"","Amount Per Unit":e.amountPerUnit||"0.000",Total:e.total||"0.000","Profit Margin":e.profitMargin||"0.000","Amount Per Unit with Profit":e.amountPerUnitWithProfit||"0.000","Total with Profit":e.totalWithProfit||"0.000"})});return a},onCloseImportDialog:function(){this.byId("importDialog").close();this.getView().getModel().setProperty("/importReady",false);this.getView().getModel().setProperty("/importRows",[]);this.byId("importStatus").setText("")},onCancelSubDialog:function(){this.byId("addSubDialog").close()},onCollapseAll:function(){const e=this.byId("treeTable");e.collapseAll()},onCollapseSelection:function(){const e=this.byId("treeTable");e.collapse(e.getSelectedIndices())},onExpandFirstLevel:function(){const e=this.byId("treeTable");e.expandToLevel(1)},onExpandSelection:function(){const e=this.byId("treeTable");e.expand(e.getSelectedIndices())},onOpenMainDialog:function(){this.byId("addMainDialog").open()},onOpenSubDialog:function(){this.byId("addSubDialog").open()},onCloseDialog:function(e){e.getSource().getParent().close()},onCloseMainItemDialog:function(){this.byId("addMainItemDialog").close()}})});
//# sourceMappingURL=Tendering.controller.js.map