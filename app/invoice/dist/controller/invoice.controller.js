sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/HBox","sap/m/VBox","sap/m/Label","sap/m/Input","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/ui/export/Spreadsheet","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/unified/FileUploader","sap/ui/layout/form/SimpleForm","sap/ui/layout/form/ResponsiveGridLayout"],(e,t,a,n)=>{"use strict";return e.extend("invoice.controller.invoice",{onInit(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("invoice").attachPatternMatched(this._onRouteMatched,this);var t=new sap.ui.model.json.JSONModel({totalValue:0,docNumber:"",TotalQuantity:0,itemNumber:"",MainItems:[]});this.getView().setModel(t)},_onRouteMatched:function(e){var t=this.getView();var a=t.getModel();var n=e.getParameter("arguments");var o=n.docNumber;var r=n.itemNumber;console.log("Params:",o,r);a.setProperty("/docNumber",o);a.setProperty("/itemNumber",r);var i={referenceId:o,debitMemoRequestItem:r};var l="/odata/v4/sales-cloud/getServiceInvoiceByReferenceId";fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>e.json()).then(e=>{console.log(e.value);const n=Array.isArray(e.value)?e.value:[];const o=n.reduce((e,t)=>e+Number(t.total||0),0);console.log("Total Value:",o);a.setProperty("/MainItems",e.value);a.setProperty("/totalValue",o);t.byId("debitmemoTable").setModel(a)}).catch(e=>{console.error("Error fetching MainItems",e)})},onExport:function(){var e=this.getView().getModel();var t=[{label:"serviceInvoiceCode.",property:"serviceInvoiceCode"},{label:"executionOrderMainCode.",property:"executionOrderMainCode"},{label:"lineNumber",property:"lineNumber"},{label:"serviceNumberCode",property:"serviceNumberCode"},{label:"description",property:"description"},{label:"actualQuantity",property:"actualQuantity"},{label:"unitOfMeasurementCode",property:"unitOfMeasurementCode"},{label:"amountPerUnit",property:"amountPerUnit"},{label:"currencyCode",property:"currencyCode"},{label:"total",property:"total"},{label:"actualQuantity",property:"actualQuantity"},{label:"actualPercentage",property:"actualPercentage"},{label:"overFulfillmentPercent",property:"overFulfillmentPercent"},{label:"unlimitedOverFulfillment",property:"unlimitedOverFulfillment"},{label:"manualPriceEntryAllowed",property:"manualPriceEntryAllowed"},{label:"materialGroupCode",property:"materialGroupCode"},{label:"serviceTypeCode",property:"serviceTypeCode"},{label:"externalServiceNumber",property:"externalServiceNumber"},{label:"serviceText",property:"serviceText"},{label:"lineText",property:"lineText"},{label:"personnelNumberCode",property:"personnelNumberCode"},{label:"lineTypeCode",property:"lineTypeCode"},{label:"biddersLine",property:"biddersLine"},{label:"supplementaryLine",property:"supplementaryLine"},{label:"lotCostOne",property:"lotCostOne"}];var a={workbook:{columns:t},dataSource:e.getProperty("/MainItems"),fileName:"Debit Memo Items.xlsx"};var n=new sap.ui.export.Spreadsheet(a);n.build().finally(function(){n.destroy()})},openOrdersDialog:function(){var e=this;var t=this.getView();var a=t.getModel();var n=a.getProperty("/docNumber");var o=a.getProperty("/itemNumber");var r=new sap.m.Dialog({title:"Select Rows to Copy",contentWidth:"90%",contentHeight:"70%",resizable:true,draggable:true,buttons:[new sap.m.Button({text:"Copy Selected",type:"Emphasized",press:function(){var t=i.getSelectedItems();if(t.length===0){sap.m.MessageToast.show("Please select at least one row.");return}var n=e.getView();var o=n.getModel();var l=o.getProperty("/MainItems")||[];t.forEach(function(e){var t=e.getBindingContext().getObject();l.push({executionOrderMainCode:t.executionOrderMainCode,lineNumber:"",serviceNumberCode:t.serviceNumberCode,description:t.description,actualQuantity:t.actualQuantity,unitOfMeasurementCode:t.unitOfMeasurementCode,amountPerUnit:t.amountPerUnit,currencyCode:t.currencyCode,total:t.total,totalQuantity:t.totalQuantity})});o.setProperty("/MainItems",l);var s=n.byId("debitmemoTable");if(s&&s.getBinding("rows")){s.getBinding("rows").refresh()}const u=o.getProperty("/MainItems");this.totalValue=u.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);a.setProperty("/totalValue",this.totalValue);console.log(" MainItems after copy:",o.getProperty("/MainItems"));sap.m.MessageToast.show("Selected rows copied to Main Items table!");r.close()}}),new sap.m.Button({text:"Cancel",type:"Reject",press:function(){r.close()}})]});var i=new sap.m.Table({mode:"MultiSelect",inset:false,columns:[new sap.m.Column({header:new sap.m.Label({text:"MainItem.NO"})}),new sap.m.Column({header:new sap.m.Label({text:"Service Number"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"UOM"})}),new sap.m.Column({header:new sap.m.Label({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Label({text:"AmountPerUnit"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})})]});r.addContent(i);$.ajax({url:`/odata/v4/sales-cloud/fetchExecutionOrderMainByDebitMemo?debitMemoRequest='${n}'&debitMemoRequestItem='${o}'`,method:"GET",success:function(e){var t=new sap.ui.model.json.JSONModel(e.value||e);i.setModel(t);i.bindItems("/",new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{invoiceMainItemCode}"}),new sap.m.Text({text:"{serviceNumberCode}"}),new sap.m.Text({text:"{description}"}),new sap.m.Text({text:"{unitOfMeasurementCode}"}),new sap.m.Text({text:"{totalQuantity}"}),new sap.m.Text({text:"{amountPerUnit}"}),new sap.m.Text({text:"{currencyCode}"})]}))},error:function(){sap.m.MessageToast.show("Failed to fetch orders data.")}});r.open()},onDeleteItem:function(e){var t=e.getSource().getBindingContext();if(t){var a=t.getPath();var n=this.getView().getModel();var o=n.getProperty(a);sap.m.MessageBox.confirm("Are you sure you want to delete item "+(o.serviceInvoiceCode||"")+"?",{title:"Confirm Deletion",onClose:function(e){if(e===sap.m.MessageBox.Action.OK){var t=n.getProperty("/MainItems");var o=parseInt(a.split("/")[2]);if(o>-1){t.splice(o,1);n.setProperty("/MainItems",t);const e=n.getProperty("/MainItems");this.totalValue=e.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);n.setProperty("/totalValue",this.totalValue);n.refresh(true);sap.m.MessageToast.show("Item deleted successfully!")}}}})}},onSaveDocument:function(){const e=this.getView().getModel();const t=e.getProperty("/MainItems")||[];const a=t.map(t=>({actualPercentage:parseInt(t.actualPercentage||"0"),actualQuantity:String(t.actualQuantity||"0"),alternatives:null,amountPerUnit:String(t.amountPerUnit||"0"),biddersLine:t.biddersLine!==undefined?t.biddersLine:true,currencyCode:t.currencyCode||null,currentPercentage:"0",debitMemoRequestItem:t.debitMemoRequestItem||"10",debitMemoRequestItemText:null,description:t.description||null,doNotPrint:t.doNotPrint!==undefined?t.doNotPrint:true,executionOrderMainCode:t.executionOrderMainCode||null,externalServiceNumber:t.externalServiceNumber||null,lineNumber:t.lineNumber||null,lineText:t.lineText||null,lineTypeCode:t.lineTypeCode||null,lotCostOne:t.lotCostOne!==undefined?t.lotCostOne:true,materialGroupCode:t.materialGroupCode||null,overFulfillmentPercent:String(t.overFulfillmentPercent||"0"),personnelNumberCode:t.personnelNumberCode||null,quantity:String(t.totalQuantity||"0"),referenceId:e.getProperty("/docNumber")||"70000000",referenceSDDocument:t.referenceSDDocument||"2",remainingQuantity:String(t.remainingQuantity||"0"),serviceNumberCode:parseInt(t.serviceNumberCode)||0,serviceText:t.serviceText||null,serviceTypeCode:t.serviceTypeCode||null,supplementaryLine:t.supplementaryLine!==undefined?t.supplementaryLine:true,temporaryDeletion:null,total:String(t.total||"0"),totalHeader:String(t.totalHeader||"0"),totalQuantity:String(t.quantity||"0"),unitOfMeasurementCode:t.unitOfMeasurementCode||null,unlimitedOverFulfillment:t.unlimitedOverFulfillment!==undefined?t.unlimitedOverFulfillment:true}));const n={serviceInvoiceCommands:a,debitMemoRequest:e.getProperty("/docNumber")||"",debitMemoRequestItem:e.getProperty("/itemNumber")||"",pricingProcedureStep:10,pricingProcedureCounter:1,customerNumber:"120000"};console.log("Payload sent to API:",n);fetch("/odata/v4/sales-cloud/saveOrUpdateServiceInvoices",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>{if(!e.ok){throw new Error("Failed to save: "+e.statusText)}return e.json()}).then(t=>{console.log(t);const a=e.getProperty("/MainItems");const n=t.value.map((e,t)=>{const n=a[t];return{...n,...e,executionOrderMainCode:n.executionOrderMainCode||e.executionOrderMainCode||null}});e.setProperty("/MainItems",n);sap.m.MessageToast.show("Document saved successfully!")}).catch(e=>{console.error("Error saving document:",e);sap.m.MessageBox.error("Error: "+e.message)})},onPrint:function(){},onImport:function(){if(!this._oValueHelpDialog){this._oValueHelpDialog=new sap.m.Dialog({title:"Import From:",content:[new sap.m.HBox({justifyContent:"SpaceAround",class:"sapUiSmallMargin",items:[new sap.m.Button({text:"Quotations?",type:"Emphasized"}),new sap.m.Button({text:"Model?",type:"Emphasized"}),new sap.m.Button({text:"Excel?",type:"Emphasized"})]})]})}this._oValueHelpDialog.open()},onAddIem:function(){this.byId("_IDGenText1").setText();var e=this.getView().getModel();var t=e.getProperty("/Items");var a=0;t.forEach(e=>{var t=e.AmountPerUnit;var n=e.QTY;var o=t*n;e.Total=o;a+=o});e.setProperty("/Items",t);if(a){this.byId("_IDGenText1").setText(a)}},onEditItem:function(e){const t=e.getSource();const a=t.getBindingContext();if(!a){sap.m.MessageToast.show("No item context found.");return}const n=a.getObject();const o=this.getView().getModel();this._editPath=a.getPath();o.setProperty("/editRow",{...n});if(!this._EditItemDialog){const e=new sap.ui.layout.form.SimpleForm({layout:"ResponsiveGridLayout",editable:true,labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,content:[new sap.m.Label({text:"Service No."}),new sap.m.Input({value:"{/editRow/serviceNumberCode}",editable:false}),new sap.m.Label({text:"Description"}),new sap.m.Input({value:"{/editRow/description}",editable:false}),new sap.m.Label({text:"UOM"}),new sap.m.Input({value:"{/editRow/unitOfMeasurementCode}",editable:false}),new sap.m.Label({text:"Amount Per Unit"}),new sap.m.Input({value:"{/editRow/amountPerUnit}",editable:false,type:"Number"}),new sap.m.Label({text:"Total Quantity"}),new sap.m.Input({value:"{/editRow/total}",editable:false,type:"Number"}),new sap.m.Label({text:"Current Quantity"}),new sap.m.Input({value:"{/editRow/currentQuantity}",type:"Number",valueLiveUpdate:true}),new sap.m.Label({text:"Remaining Quantity"}),new sap.m.Input({value:"{/editRow/remainingQuantity}",editable:false}),new sap.m.Label({text:"Actual Total Quantity"}),new sap.m.Input({value:"{/editRow/actualQuantity}",editable:false}),new sap.m.Label({text:"Actual Total Percentage %"}),new sap.m.Input({value:"{/editRow/actualPercentage}",editable:false}),new sap.m.Label({text:"Current Percentage"}),new sap.m.Input({value:"{/editRow/currentPercentage}",editable:false}),new sap.m.Label({text:"Currency"}),new sap.m.Input({value:"{/editRow/currencyCode}",editable:false}),new sap.m.Label({text:"Material Group"}),new sap.m.Input({value:"{/editRow/materialGroupCode}",editable:false}),new sap.m.Label({text:"Service Type"}),new sap.m.Input({value:"{/editRow/serviceTypeCode}",editable:false}),new sap.m.Label({text:"External Service Number"}),new sap.m.Input({value:"{/editRow/externalServiceNumber}",editable:false}),new sap.m.Label({text:"Service Text"}),new sap.m.Input({value:"{/editRow/serviceText}",editable:false}),new sap.m.Label({text:"Line Text"}),new sap.m.Input({value:"{/editRow/lineText}",editable:false}),new sap.m.Label({text:"Personnel No."}),new sap.m.Input({value:"{/editRow/personnelNumberCode}",editable:false}),new sap.m.Label({text:"Line Type"}),new sap.m.Input({value:"{/editRow/lineTypeCode}",editable:false}),new sap.m.Label({text:"Bidders' Line"}),new sap.m.CheckBox({selected:"{/editRow/biddersLine}",editable:false}),new sap.m.Label({text:"Supplementary Line"}),new sap.m.CheckBox({selected:"{/editRow/supplementaryLine}",editable:false}),new sap.m.Label({text:"Lot Cost One"}),new sap.m.CheckBox({selected:"{/editRow/lotCostOne}",editable:false}),new sap.m.Label({text:"Current Amount"}),new sap.m.Input({value:"{/editRow/total}",editable:false})]});this._EditItemDialog=new sap.m.Dialog({title:"Edit Debit Memo Item",contentWidth:"700px",resizable:true,draggable:true,content:[e],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:this.onSaveEdit.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._EditItemDialog.close();this._EditItemDialog.destroy();this._EditItemDialog=null}.bind(this)})});this.getView().addDependent(this._EditItemDialog)}this._EditItemDialog.open()},onSaveEdit:function(){const e=this.getView().getModel();const t=e.getProperty("/editRow");const a=e.getProperty("/editRow");const n={executionOrderMainCode:a.executionOrderMainCode,quantity:a.currentQuantity||0,totalQuantity:a.total||0,amountPerUnit:a.amountPerUnit||0};console.log("Payload sent to /calculateQuantities:",n);fetch("/odata/v4/sales-cloud/calculateQuantitiesWithoutAccumulation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(e=>{if(!e.ok)throw new Error("API request failed");return e.json()}).then(t=>{console.log("Calculation API response:",t);a.actualQuantity=parseInt(t.total);a.remainingQuantity=parseInt(t.remainingQuantity);a.actualPercentage=parseFloat(t.actualPercentage);a.totalHeader=parseInt(t.totalHeader);e.setProperty("/editRow",a)}).catch(e=>{console.error("Error calling calculateQuantities:",e);sap.m.MessageToast.show("Failed to calculate quantities")});if(this._editPath){e.setProperty(this._editPath,t)}const o=e.getProperty("/MainItems");this.totalValue=o.reduce((e,t)=>e+Number(t.total||0),0);console.log(this.totalValue);e.setProperty("/totalValue",this.totalValue);this._EditItemDialog.close();this._EditItemDialog.destroy();this._EditItemDialog=null;sap.m.MessageToast.show("Item updated successfully!")},_onValueChange:function(){const e=this.getView().getModel()}})});
//# sourceMappingURL=invoice.controller.js.map